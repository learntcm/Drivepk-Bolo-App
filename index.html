const GOOGLE_KEY = "AIzaSyAzEgST_gBAhua-L0VZyiL6tryuQ-zaSRg"; 
    const OPENAI_KEY = "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";

    async function speakReshma(text) {
        if (!text) return;
        
        // Use SSML for a clear "Welcome to DrivePK" with a natural pause
        const ssmlData = `<speak>Welcome to DrivePK. <break time='400ms'/> ${text}</speak>`;

        try {
            const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_KEY}`, {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    input: { ssml: ssmlData },
                    voice: { languageCode: "ur-PK", name: "ur-PK-Wavenet-A" },
                    audioConfig: { 
                        audioEncoding: "MP3", 
                        pitch: -0.5, 
                        speakingRate: 0.95,
                        effectsProfileId: ["telephony-class-application"]
                    }
                })
            });

            const data = await response.json();
            if (data.audioContent) {
                const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
                // This play() call is now directly inside the user-click event chain
                await audio.play();
            } else if (data.error) {
                console.error("Google Error:", data.error.message);
            }
        } catch (e) {
            console.error("Execution Error:", e);
        }
    }

    // Fixed the "Call" button to trigger the welcome message immediately
    document.getElementById("callBtn").addEventListener("click", function() {
        const welcomeTxt = "Main Reshma hoon. Aap konsi gaari dhoond rahe hain?";
        document.getElementById("results").innerHTML = `<div class="ai-message"><b>Reshma:</b><br>Welcome to DrivePK! ${welcomeTxt}</div>`;
        speakReshma(welcomeTxt);
    });

    // Mic Logic
    const micBtn = document.getElementById("micBtn");
    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'ur-PK';
        
        micBtn.onclick = () => { recognition.start(); };
        
        recognition.onresult = async (event) => {
            const query = event.results[0][0].transcript;
            handleSearch(query);
        };
    }

    async function handleSearch(query) {
        document.getElementById("results").innerHTML = `<div class="ai-message"><b>Searching...</b></div>`;
        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${OPENAI_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [{role: "system", content: "You are Reshma from DrivePK. Answer in 1 short Roman Urdu sentence."}, {role: "user", content: query}]
                })
            });
            const data = await response.json();
            const reply = data.choices[0].message.content;
            document.getElementById("results").innerHTML = `<div class="ai-message"><b>Reshma:</b><br>${reply}</div>`;
            speakReshma(reply);
        } catch (e) { console.error(e); }
    }
