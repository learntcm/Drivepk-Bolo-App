<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>

<!-- ‚úÖ PWA REQUIRED (INSTALL APP will appear) -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#E81F25">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e6e6e6;}
  header{background:#000;color:#fff;padding:10px;display:flex;gap:10px;align-items:center;}
  .logo{background:#E81F25;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;}
  .main{padding:10px;max-width:520px;margin:0 auto;}
  .hero{background:#000;border-radius:18px;height:22vh;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:10px;}
  .hero h1{font-size:30px;margin:0;}
  .hero h2{font-size:14px;color:#E81F25;margin-top:4px;}

  input,button{width:100%;height:46px;border-radius:12px;font-size:15px;box-sizing:border-box;}
  input{padding:0 14px;border:1px solid #ccc;margin-bottom:6px;}
  button{border:none;background:#000;color:#fff;cursor:pointer;}

  .row{display:flex;gap:8px;}
  .row button{flex:1;}

  .call{background:#E81F25;font-size:16px;margin-top:6px;user-select:none;transition:filter .08s ease,transform .08s ease;}
  .call.calling{background:#999;color:#000;}
  .call.talking{filter:brightness(0.78);transform:scale(0.985);}

  #hint{margin-top:6px;font-size:12px;color:#333;opacity:.85;}
  #status{margin-top:6px;font-weight:bold;color:#E81F25;font-size:14px;}
  #results{margin-top:10px;}

  .card{background:#fff;border-radius:12px;padding:10px;margin-bottom:10px;}
  .car{background:#fff;border-radius:12px;padding:8px;margin-bottom:10px;cursor:pointer;}
  .car img{width:100%;height:140px;object-fit:cover;border-radius:8px;}

  .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;}
  .muted{opacity:.75;font-size:12px;}
  .btnRed{background:#E81F25 !important;}

  /* Support box */
  #supportBox{display:none;margin-top:10px;background:#fff;border-radius:12px;padding:10px;}

  /* Modal */
  .modalBack{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; z-index:9999;
    padding:12px;
  }
  .modal{
    width:100%; max-width:420px; background:#fff; border-radius:14px; padding:12px;
  }
  .modal h3{margin:0 0 8px 0;}
  .modal .row2{display:flex; gap:8px; margin-top:8px;}
  .modal .row2 button{flex:1; height:44px;}
  .xbtn{float:right;background:#eee;color:#000;width:40px;height:36px;border-radius:10px;}
  .small{font-size:12px; opacity:.8; margin-top:6px;}
  .ok{color:#0a7a2f; font-weight:bold;}
  .bad{color:#b00020; font-weight:bold;}

  /* Detail Page (kept for future use; search now redirects) */
  #detailPage{
    position:fixed; inset:0; background:#fff; z-index:999; display:none; overflow-y:auto;
  }
  .detailHeader{
    background:#000;color:#fff;padding:10px;display:flex;align-items:center;gap:10px;position:sticky;top:0;
  }
  .detailHeader button{background:#E81F25;border-radius:10px;padding:8px 10px;color:#fff;}
  .galleryWrap{background:#000;position:relative;}
  .gallery{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;}
  .gallery img{width:100%;height:240px;object-fit:cover;scroll-snap-align:start;flex-shrink:0;border-right:6px solid #000;}
  .swipe{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;}
  .detailBody{padding:12px;}
  .price{font-size:22px;font-weight:bold;margin:6px 0 12px 0;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
  .box{background:#111;color:#fff;border-radius:12px;padding:10px 6px;text-align:center;font-size:13px;}
  .box strong{display:block;font-size:15px;margin-top:4px;}
  .contactBox{background:#000;color:#fff;border-radius:14px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .contactBtn{background:#E81F25;color:#fff;border-radius:12px;padding:10px 12px;font-weight:bold;min-width:140px;text-align:center;}
  .lock{opacity:.7;font-size:13px;}
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br />
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: MG Lahore 2022" />
  <div class="row">
    <button id="searchBtn">Search</button>
    <button id="authBtn" class="btnRed">Login</button>
  </div>

  <button class="call" id="callBtn">CALL</button>
  <div id="hint">Call dabayen. Phir mic ko press & hold karke bolen.</div>

  <div id="status"></div>

  <div id="supportBox" class="card">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px;font-size:18px;color:#E81F25;font-weight:bold;">0300 8319037</div>
    <div class="small">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<!-- DETAIL PAGE (kept, not used in new redirect search flow) -->
<div id="detailPage">
  <div class="detailHeader">
    <button id="backBtn">‚Üê Back</button>
    <strong id="detailTitle"></strong>
  </div>

  <div class="galleryWrap">
    <div class="gallery" id="gallery"></div>
    <div class="swipe">Swipe ‚á† ‚á¢</div>
  </div>

  <div class="detailBody">
    <div class="price" id="detailPrice"></div>

    <div class="grid" id="specGrid"></div>

    <div class="contactBox">
      <div>
        <div class="lock" id="contactHint">üîí Login to view phone number</div>
        <div class="muted" id="sellerName"></div>
      </div>
      <div class="contactBtn" id="contactBtn">Contact Seller</div>
    </div>

    <div id="phoneBox" class="card" style="display:none;margin-top:10px;">
      <div class="pill">Contact</div>
      <div style="margin-top:6px;font-size:20px;font-weight:bold;color:#E81F25;" id="realPhone"></div>
      <div class="small" id="phoneOwner"></div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <button class="xbtn" id="closeModal">‚úï</button>
    <h3 id="modalTitle">Login</h3>

    <div id="modalMsg" class="small"></div>

    <div id="loginForm">
      <input id="loginEmail" placeholder="Email" />
      <input id="loginPass" placeholder="Password" type="password" />
      <div class="row2">
        <button id="doLogin" class="btnRed">Login</button>
        <button id="goRegister">Register</button>
      </div>
      <div class="small">If token expires, we auto-refresh.</div>
    </div>

    <div id="registerForm" style="display:none;">
      <input id="regName" placeholder="Full Name" />
      <input id="regEmail" placeholder="Email" />
      <input id="regPhone" placeholder="Phone (3001234567)" />
      <input id="regPass" placeholder="Password (Password123)" type="password" />
      <input id="regPass2" placeholder="Confirm Password" type="password" />
      <div class="row2">
        <button id="doRegister" class="btnRed">Create</button>
        <button id="goLogin">Back</button>
      </div>
    </div>

    <div id="loggedInBox" style="display:none;">
      <div class="card">
        <div class="pill">Logged In</div>
        <div style="margin-top:6px;font-weight:bold;" id="whoami"></div>
        <div class="small" id="whoEmail"></div>
      </div>
      <button id="logoutBtn" style="background:#000;margin-top:8px;">Logout</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const GATEWAY_API = "https://meilibeauty.co.uk/search.php"; // kept for login/refresh/phone
const COMPANY_NUMBER = "051 8319037";
const WEBSITE = "www.drivepk.com";
const OFFICE_ADDRESS = "195, Peshawar Road, Chur Chowk Beside PSO Pump, Westridge, Rawalpindi.";

const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const VOICE_BY_LADY = {
  "Kiran":    { voice:"marin",   speed:0.95 },
  "Reshma":   { voice:"cedar",   speed:0.95 },
  "Mahnoor":  { voice:"shimmer", speed:0.98 },
  "Gul Noor": { voice:"coral",   speed:0.95 },
  "Dil Bahar":{ voice:"nova",    speed:0.98 },
  "Shaheen":  { voice:"sage",    speed:0.95 }
};

// Boss voice pack
const BOSS_UMAR = { voice:"onyx", speed:0.95 };

const UNKNOWN_LINES = [
  "Sorry, abhi mujhe is ka jawab maloom nahi hai.",
  "Abhi main sirf gaari search mein help karti hoon. Aap car ka model, year aur city bol dein.",
  "Maazrat, is cheez mein help nahi ho pa rahi. Aap gaari ka brand aur city batayein."
];

const SILENCE_MS = 5000;
const END_WAIT_MS = 650;     // slightly shorter helps on Android
const MIN_HOLD_MS = 400;

/* =========================
   STATE
========================= */
let callConnected = false;

// Speech recognition lifecycle (recreated per attempt)
let recognition = null;
let isRecognizing = false;
let transcript = "";
let silenceTimer = null;

let micReady = false;
let holding = false;
let holdStartTs = 0;
let micFailCount = 0;
let stopRequested = false;
let restartWhileHolding = true;

let currentAudio = null;
let speakSeq = 0;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }

function getTokens(){
  return {
    access: localStorage.getItem("dp_access") || "",
    refresh: localStorage.getItem("dp_refresh") || "",
    expiresAt: parseInt(localStorage.getItem("dp_expiresAt") || "0", 10) || 0,
    user: JSON.parse(localStorage.getItem("dp_user") || "null")
  };
}
function setTokens(data){
  if(!data) return;
  if(data.access_token) localStorage.setItem("dp_access", data.access_token);
  if(data.refresh_token) localStorage.setItem("dp_refresh", data.refresh_token);
  if(typeof data.expires_in === "number"){
    localStorage.setItem("dp_expiresAt", String(Date.now() + (data.expires_in*1000) - 5000));
  }
  if(data.user) localStorage.setItem("dp_user", JSON.stringify(data.user));
}
function clearTokens(){
  localStorage.removeItem("dp_access");
  localStorage.removeItem("dp_refresh");
  localStorage.removeItem("dp_expiresAt");
  localStorage.removeItem("dp_user");
}

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function setStatus(t){ $("status").innerText = t || ""; }
function clearSilence(){ if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; } }
function showSupport(){ $("supportBox").style.display = "block"; }
function hideSupport(){ $("supportBox").style.display = "none"; }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randLady(){ return LADIES[Math.floor(Math.random()*LADIES.length)]; }
function normalize(t){ return (t||"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim(); }

function getOrAssignLady(){
  const p = getProfile();
  if(!p.lady){ p.lady = randLady(); saveProfile(p); }
  return p.lady;
}

function isDoctorName(nm){
  const s = (nm||"").toLowerCase().trim();
  return s.startsWith("dr") || s.startsWith("doctor") || s.includes(" dr ") || s.includes("doctor ");
}

function respectfulName(profile){
  if(!profile || !profile.name) return "bhai";
  const nm = (profile.name||"").trim();
  if(isDoctorName(nm)) return "Dr sahib";
  return nm.split(" ")[0] + " bhai";
}

function extractName(text){
  const t = (text||"").trim();
  const m = t.match(/(my name is|mera naam)\s+(.+)/i);
  let raw = m ? m[2] : t;
  raw = raw.replace(/[^a-zA-Z\s]/g," ").replace(/\s+/g," ").trim();
  if(!raw) return null;
  const parts = raw.split(" ").slice(0,3);
  return parts.map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
}

function getLadyVoicePack(){
  const p = getProfile();
  const lady = p.lady || getOrAssignLady();
  return VOICE_BY_LADY[lady] || { voice:"marin", speed:0.95 };
}

/* =========================
   SEARCH REDIRECT (Android-style results page)
========================= */
function redirectToResults(queryText){
  const q = (queryText || "").trim();
  if(!q) return;
  window.location.href = "search-results.html?q=" + encodeURIComponent(q);
}

/* =========================
   VOICE / MIC (TTS)
========================= */
function stopAllVoice(){
  if(currentAudio){
    try{ currentAudio.pause(); currentAudio.currentTime = 0; }catch(e){}
    currentAudio = null;
  }
}

function stopMic(){
  stopRequested = true;
  clearSilence();

  if(!recognition) return;
  try{ recognition.onresult=null; recognition.onerror=null; recognition.onend=null; }catch(e){}
  try{ recognition.abort(); }catch(e){}
  try{ recognition.stop(); }catch(e){}
  isRecognizing = false;
  recognition = null;
}

async function warmupMic(){
  if(micReady) return true;
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    micReady = true;
    return true;
  }catch{
    return false;
  }
}

async function speak(text, voicePack){
  const mySeq = ++speakSeq;
  stopMic();
  stopAllVoice();
  clearSilence();
  setStatus(text);

  const vp = voicePack || getLadyVoicePack();
  const safeSpeed = Number((vp.speed || 0.95).toFixed(2));

  let res;
  try{
    res = await fetch(VOICE_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, voice: vp.voice, speed: safeSpeed })
    });
  }catch{
    return;
  }

  if(!res || !res.ok) return;

  const blob = await res.blob();
  if(mySeq !== speakSeq) return;

  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    const done = ()=>{ if(mySeq===speakSeq) currentAudio=null; resolve(); };
    audio.onended = done;
    audio.onerror = done;
    audio.play().catch(done);
  });
}

async function ring(){
  const times = Math.floor(Math.random()*3)+1;
  for(let i=0;i<times;i++){
    await new Promise(r=>{
      const a = new Audio("ringtone.mp4");
      a.onended = ()=>setTimeout(r,350);
      a.play().catch(r);
    });
  }
}

/* =========================
   Speech Recognition (RELIABLE ANDROID FIX)
========================= */
function isSpeechSupported(){
  return ("webkitSpeechRecognition" in window);
}

function createRecognition(){
  if(!isSpeechSupported()) return null;
  const r = new webkitSpeechRecognition();
  r.lang = "en-IN";
  r.interimResults = true;
  r.continuous = false; // IMPORTANT: more stable on Android PWA
  return r;
}

async function startRecognitionWithRetry(maxAttempts){
  stopRequested = false;

  // Always recreate recognition to avoid "stuck mic"
  recognition = createRecognition();
  if(!recognition) return { ok:false, reason:"unsupported" };

  transcript = "";
  isRecognizing = true;

  recognition.onresult = (e)=>{
    try{
      let lastFinal = "";
      let lastAny = "";
      for(let i=0;i<e.results.length;i++){
        const rr = e.results[i];
        const txt = rr && rr[0] && rr[0].transcript ? rr[0].transcript : "";
        if(txt) lastAny = txt;
        if(rr && rr.isFinal && txt) lastFinal = txt;
      }
      transcript = (lastFinal || lastAny || transcript || "");
    }catch(err){}
  };

  recognition.onerror = async (ev)=>{
    const err = (ev && ev.error) ? String(ev.error) : "unknown";
    isRecognizing = false;
    clearSilence();

    if(err === "not-allowed" || err === "service-not-allowed"){
      await speak("Mic permission allow nahi. Please site settings mein microphone allow karein.");
      holding = false;
      return;
    }
    if(err === "audio-capture"){
      await speak("Mic capture nahi ho raha. Please headphone/bluetooth off karke dobara try karein.");
      holding = false;
      return;
    }
    if(err === "network"){
      await speak("Network issue ki wajah se mic kaam nahi kar raha. Please internet check karein.");
      holding = false;
      return;
    }
  };

  recognition.onend = ()=>{
    isRecognizing = false;
    clearSilence();

    // While holding, auto-restart quickly
    if(holding && restartWhileHolding && !stopRequested){
      setTimeout(async ()=>{
        if(holding && !stopRequested){
          await startRecognitionWithRetry(2);
        }
      }, 150);
    }
  };

  for(let attempt=1; attempt<=maxAttempts; attempt++){
    if(stopRequested) break;
    try{
      recognition.start();
      return { ok:true };
    }catch(e){
      await new Promise(r=>setTimeout(r, 250 * attempt));
      recognition = createRecognition();
      if(!recognition) break;

      recognition.onresult = (e)=>{ try{
        let lastFinal="", lastAny="";
        for(let i=0;i<e.results.length;i++){
          const rr=e.results[i];
          const txt=rr && rr[0] && rr[0].transcript ? rr[0].transcript : "";
          if(txt) lastAny=txt;
          if(rr && rr.isFinal && txt) lastFinal=txt;
        }
        transcript = (lastFinal || lastAny || transcript || "");
      }catch(err){} };

      recognition.onerror = async (ev)=>{
        const err = (ev && ev.error) ? String(ev.error) : "unknown";
        isRecognizing = false;
        clearSilence();
        if(err === "not-allowed" || err === "service-not-allowed"){
          await speak("Mic permission allow nahi. Please site settings mein microphone allow karein.");
          holding = false;
          return;
        }
        if(err === "audio-capture"){
          await speak("Mic capture nahi ho raha. Please headphone/bluetooth off karke dobara try karein.");
          holding = false;
          return;
        }
        if(err === "network"){
          await speak("Network issue ki wajah se mic kaam nahi kar raha. Please internet check karein.");
          holding = false;
          return;
        }
      };

      recognition.onend = ()=>{
        isRecognizing = false;
        clearSilence();
        if(holding && restartWhileHolding && !stopRequested){
          setTimeout(async ()=>{
            if(holding && !stopRequested){
              await startRecognitionWithRetry(2);
            }
          }, 150);
        }
      };
    }
  }

  return { ok:false, reason:"start_failed" };
}

async function startListening(){
  if(!callConnected || holding) return;
  holding = true;
  holdStartTs = Date.now();

  stopAllVoice();
  hideSupport();

  const btn = $("callBtn");
  btn.classList.add("talking");
  btn.innerText = "LISTENING...";
  setStatus("Sun rahi hoon...");

  if(!isSpeechSupported()){
    holding = false;
    btn.classList.remove("talking");
    btn.innerText = "HOLD TO TALK";
    await speak("Mic supported nahi hai. Please type karke search karein.");
    return;
  }

  const ok = await warmupMic();
  if(!ok){
    holding = false;
    btn.classList.remove("talking");
    btn.innerText = "HOLD TO TALK";
    await speak("Mic permission allow nahi. Please type kar dein.");
    return;
  }

  clearSilence();
  silenceTimer = setTimeout(async ()=>{
    if(holding && (!transcript || !transcript.trim())){
      const p = getProfile();
      await speak(respectfulName(p) + ", model, year aur city bol dein.");
    }
  }, SILENCE_MS);

  const r = await startRecognitionWithRetry(3);
  if(!r.ok){
    holding = false;
    btn.classList.remove("talking");
    btn.innerText = "HOLD TO TALK";
    await speak("Mic start nahi ho raha. Please ek dafa refresh karke dobara try karein.");
    return;
  }
}

async function stopListening(){
  if(!holding) return;
  holding = false;

  const btn = $("callBtn");
  btn.classList.remove("talking");
  btn.innerText = "HOLD TO TALK";

  const heldMs = Date.now() - holdStartTs;
  if(heldMs < MIN_HOLD_MS) await new Promise(r=>setTimeout(r, MIN_HOLD_MS - heldMs));

  stopMic();
  await new Promise(r=>setTimeout(r, END_WAIT_MS));

  const spoken = (transcript || "").trim();
  if(!spoken){
    micFailCount++;
    if(micFailCount === 1){
      await speak("Awaaz clear nahi aayi. Button ko press karke hold rakhein, phir bol kar release karein.");
    } else {
      await speak("Lagta hai mic record nahi kar raha. Aap type karke bhi likh sakte hain.");
    }
    return;
  }

  micFailCount = 0;
  await handleSpoken(spoken);
}

/* =========================
   INTENTS + FAQ
========================= */
function wantsBoss(t){
  t = normalize(t);
  return ["boss","manager","supervisor","owner","boss se baat","boss se milao","boss se baat karwao","mujhe boss se baat karni hai","umar","umar se baat"].some(x=>t.includes(x));
}
function wantsComplaint(t){
  t = normalize(t);
  return ["complaint","complain","shikayat","issue","problem","masla","support","customer care"].some(x=>t.includes(x));
}
function wantsNewLady(t){
  t = normalize(t);
  return ["change lady","switch lady","another lady","other lady","dusri madam","dusri lady","aur madam chahiye","koi aur lady","dusri madam se baat karwao","koi khoobsurat lady chahiye"].some(x=>t.includes(x));
}
function isAskingMyName(t){
  t = normalize(t);
  return t.includes("your name") || t.includes("aap ka naam") || t.includes("ap ka naam") || t.includes("naam kya");
}
function isAskingAddress(t){
  t = normalize(t);
  return t.includes("address") || t.includes("office") || t.includes("location") || t.includes("kidhar") || t.includes("kahan") || t.includes("pata");
}
function isAskingPhone(t){
  t = normalize(t);
  return t.includes("phone") || t.includes("number") || t.includes("contact") || t.includes("whatsapp");
}
function isAskingWebsite(t){
  t = normalize(t);
  return t.includes("website") || t.includes("site") || t.includes("url") || t.includes("link");
}

const BRANDS=["toyota","honda","suzuki","kia","hyundai","mg","haval","changan","byd","nissan","bmw","audi","mercedes","proton","dfsk","baic","isuzu","jac","peugeot"];
const CITIES=["lahore","karachi","islamabad","rawalpindi","peshawar","multan","faisalabad","quetta","sialkot","gujranwala","abbottabad","mansehra","swat"];
function looksLikeCarSearch(t){
  const x = normalize(t);
  if(!x) return false;
  if(/\b(19|20)\d{2}\b/.test(x)) return true;
  if(x.includes("gaari")||x.includes("car")||x.includes("model")||x.includes("year")) return true;
  if(BRANDS.some(b=>x.includes(b))) return true;
  if(CITIES.some(c=>x.includes(c))) return true;
  return false;
}

/* =========================
   GATEWAY CALLS (search.php) - kept for auth + refresh + carPhone
========================= */
async function gateway(payload){
  const res = await fetch(GATEWAY_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  let json = null;
  try{ json = await res.json(); }catch(e){}
  return { ok: res.ok, status: res.status, json };
}

function isTokenExpired(){
  const t = getTokens();
  return !t.access || (t.expiresAt && Date.now() > t.expiresAt);
}

async function refreshIfNeeded(){
  const t = getTokens();
  if(!t.refresh) return false;
  if(!isTokenExpired()) return true;

  const r = await gateway({ action:"refresh", refreshToken: t.refresh });
  if(r.ok && r.json && r.json.success && r.json.data){
    setTokens(r.json.data);
    return true;
  }
  return false;
}

async function doLogin(email, password){
  const r = await gateway({ action:"login", email, password });
  if(r.ok && r.json && r.json.success && r.json.data){
    setTokens(r.json.data);
    return { ok:true, msg:r.json.message || "Login successful" };
  }
  return { ok:false, msg:(r.json && r.json.message) ? r.json.message : "Login failed" };
}

async function doRegister(payload){
  payload.action = "register";
  const r = await gateway(payload);
  if(r.ok && r.json && r.json.success && r.json.data){
    setTokens(r.json.data);
    return { ok:true, msg:r.json.message || "Registration successful" };
  }
  return { ok:false, msg:(r.json && r.json.message) ? r.json.message : "Registration failed" };
}

async function getCarPhone(carIdOrSlug){
  const ok = await refreshIfNeeded();
  if(!ok){
    return { ok:false, msg:"Please login first (verified phone/email required)." };
  }
  const token = getTokens().access;
  const r = await gateway({ action:"carPhone", id: carIdOrSlug, token });
  if(r.ok && r.json && r.json.phone){
    return { ok:true, data:r.json };
  }
  const msg = (r.json && (r.json.message || r.json.error)) ? (r.json.message || r.json.error) : "Unable to fetch phone";
  return { ok:false, msg };
}

/* =========================
   CONVERSATION ROUTER
========================= */
async function handleSpoken(text){
  const p = getProfile();
  const who = respectfulName(p);

  if(!p.name){
    if(isAskingMyName(text)){
      const lady = p.lady || getOrAssignLady();
      await speak("Mera naam " + lady + " hai. Kia main aap ka naam pooch sakti hoon?");
      return;
    }
    const nm = extractName(text);
    if(!nm){
      await speak("Naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      return;
    }
    p.name = nm;
    saveProfile(p);
    await speak("Shukriya " + respectfulName(p) + ". Ab apni requirement bol dein.");
    return;
  }

  if(isAskingAddress(text)){ await speak(who + ", hamara office address hai: " + OFFICE_ADDRESS); return; }
  if(isAskingPhone(text)){ showSupport(); await speak(who + ", contact number hai: " + COMPANY_NUMBER + ". WhatsApp bhi isi par hai."); return; }
  if(isAskingWebsite(text)){ await speak(who + ", hamari website hai: " + WEBSITE); return; }

  if(wantsComplaint(text)){
    showSupport();
    await speak(who + ", complaint ke liye please is number par call karein: " + COMPANY_NUMBER + ".");
    return;
  } else {
    hideSupport();
  }

  if(wantsBoss(text)){
    await speak(who + ", theek hai. Main aap ko Umar se connect kar rahi hoon.");
    await ring();
    await speak(who + ", Assalam o Alaikum. Main Umar hoon. Aap ki kasai madad karo?", BOSS_UMAR);
    return;
  }

  if(wantsNewLady(text)){
    const cur = p.lady || getOrAssignLady();
    const others = LADIES.filter(x=>x!==cur);
    p.lady = rand(others.length ? others : LADIES);
    saveProfile(p);
    const newLady = p.lady;

    await speak(who + ", theek hai. Ab " + newLady + " baat karegi.");
    await speak("Assalam o Alaikum " + who + ". Main " + newLady + " hoon.");
    return;
  }

  if(isAskingMyName(text)){
    const lady = p.lady || getOrAssignLady();
    await speak(who + ", mera naam " + lady + " hai.");
    return;
  }

  if(!looksLikeCarSearch(text)){
    await speak(rand(UNKNOWN_LINES));
    return;
  }

  $("query").value = text;
  setStatus("Opening results...");
  redirectToResults(text);
}

/* =========================
   CONNECT CALL
========================= */
async function connectCall(){
  stopAllVoice();
  stopMic();
  hideSupport();

  const btn = $("callBtn");
  btn.classList.add("calling");
  btn.innerText = "CALLING...";
  btn.disabled = true;

  await ring();

  callConnected = true;
  btn.classList.remove("calling");
  btn.disabled = false;
  btn.innerText = "HOLD TO TALK";
  $("hint").innerText = "Press & hold and speak.";

  const p = getProfile();
  const lady = getOrAssignLady();

  if(!p.name){
    await speak("Assalam o Alaikum! DrivePK mein khush aamadid. Mera naam " + lady + " hai. Kia main aap ka naam pooch sakti hoon?");
  }else{
    await speak(respectfulName(p) + ", Assalam o Alaikum. Model, year aur city bol dein.");
  }

  await warmupMic();
}

/* =========================
   AUTH MODAL UI
========================= */
function openAuthModal(){
  $("modalBack").style.display = "flex";
  renderAuthState();
}
function closeAuthModal(){
  $("modalBack").style.display = "none";
  $("modalMsg").innerHTML = "";
}
function setModalMsg(ok, msg){
  $("modalMsg").innerHTML = `<span class="${ok?'ok':'bad'}">${msg}</span>`;
}

function renderAuthState(){
  const t = getTokens();
  if(t.access){
    $("modalTitle").innerText = "Account";
    $("loginForm").style.display = "none";
    $("registerForm").style.display = "none";
    $("loggedInBox").style.display = "block";
    const u = t.user || {};
    $("whoami").innerText = u.full_name || u.name || "Logged in";
    $("whoEmail").innerText = u.email || "";
    $("authBtn").innerText = "Account";
  }else{
    $("modalTitle").innerText = "Login";
    $("loginForm").style.display = "block";
    $("registerForm").style.display = "none";
    $("loggedInBox").style.display = "none";
    $("authBtn").innerText = "Login";
  }
}

/* =========================
   EVENTS
========================= */
$("callBtn").addEventListener("click", async ()=>{
  if(!callConnected) await connectCall();
});

$("callBtn").addEventListener("pointerdown", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  try{ e.target.setPointerCapture(e.pointerId); }catch(err){}
  startListening();
});
$("callBtn").addEventListener("pointerup", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});
$("callBtn").addEventListener("pointercancel", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

$("searchBtn").addEventListener("click", async ()=>{
  const t = ($("query").value || "").trim();
  if(!t) return;
  if(!looksLikeCarSearch(t)){
    await speak(rand(UNKNOWN_LINES));
    return;
  }
  setStatus("Opening results...");
  redirectToResults(t);
});

$("authBtn").addEventListener("click", ()=>{
  openAuthModal();
});

$("closeModal").addEventListener("click", closeAuthModal);
$("modalBack").addEventListener("click", (e)=>{
  if(e.target === $("modalBack")) closeAuthModal();
});

$("goRegister").addEventListener("click", ()=>{
  $("modalTitle").innerText = "Register";
  $("loginForm").style.display = "none";
  $("registerForm").style.display = "block";
  $("loggedInBox").style.display = "none";
  $("modalMsg").innerHTML = "";
});

$("goLogin").addEventListener("click", ()=>{
  $("modalTitle").innerText = "Login";
  $("loginForm").style.display = "block";
  $("registerForm").style.display = "none";
  $("loggedInBox").style.display = "none";
  $("modalMsg").innerHTML = "";
});

$("doLogin").addEventListener("click", async ()=>{
  const email = ($("loginEmail").value||"").trim();
  const pass  = ($("loginPass").value||"").trim();
  if(!email || !pass){
    setModalMsg(false, "Email aur password required.");
    return;
  }
  setModalMsg(true, "Logging in...");
  const r = await doLogin(email, pass);
  setModalMsg(r.ok, r.msg);
  if(r.ok){
    renderAuthState();
    await speak("Login ho gaya. Ab aap phone number dekh sakte hain.");
  }
});

$("doRegister").addEventListener("click", async ()=>{
  const payload = {
    name: ($("regName").value||"").trim(),
    email: ($("regEmail").value||"").trim(),
    phone: ($("regPhone").value||"").trim(),
    password: ($("regPass").value||"").trim(),
    confirmPassword: ($("regPass2").value||"").trim(),
    subscribeToNewsletter: true
  };
  if(!payload.name || !payload.email || !payload.phone || !payload.password || !payload.confirmPassword){
    setModalMsg(false, "Sab fields fill karein.");
    return;
  }
  setModalMsg(true, "Creating account...");
  const r = await doRegister(payload);
  setModalMsg(r.ok, r.msg);
  if(r.ok){
    renderAuthState();
    await speak("Account ban gaya. Ab verification complete karke phone dekh sakte hain.");
  }
});

$("logoutBtn").addEventListener("click", async ()=>{
  clearTokens();
  setModalMsg(true, "Logged out.");
  renderAuthState();
  await speak("Theek hai, logout ho gaya.");
});

/* =========================
   INIT
========================= */
(function init(){
  hideSupport();
  setStatus("");
  const t = getTokens();
  $("authBtn").innerText = t.access ? "Account" : "Login";

  // ‚úÖ PWA INSTALL (Service Worker)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
})();
</script>
</body>
</html>
