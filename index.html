<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
header { background:#000; color:#fff; padding:12px; display:flex; gap:12px; align-items:center; }
.logo { background:#E81F25; width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; }
.main { padding:12px; }
.hero { background:#000; border-radius:20px; height:26vh; min-height:170px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:12px; }
.hero h1 { font-size:36px; margin:0; }
.hero h2 { font-size:16px; color:#E81F25; margin-top:6px; }
input,button { width:100%; height:52px; border-radius:14px; font-size:16px; }
input { padding:0 16px; border:1px solid #ccc; margin-bottom:8px; }
button { border:none; background:#000; color:#fff; cursor:pointer; }
.call { background:#E81F25; font-size:18px; margin-top:6px; }
.call.calling { background:#999; color:#000; }
#status { margin-top:8px; font-weight:bold; color:#E81F25; }
#results { margin-top:12px; }
.car { background:#fff; border-radius:14px; padding:10px; margin-bottom:12px; }
.car img { width:100%; height:160px; object-fit:cover; border-radius:10px; }
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Roman Urdu Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const TONES  = ["friendly","direct","formal"];

// IMPORTANT: this delay prevents Chrome from cutting audio when mic starts
const MIC_SAFE_DELAY_MS = 1100;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){ p.lady = rand(LADIES); saveProfile(p); }
  return p.lady;
}
function getOrAssignTone(){
  const p=getProfile();
  if(!p.tone){ p.tone = rand(TONES); saveProfile(p); }
  return p.tone;
}

/* =========================
   RECOGNITION (MIC)
========================= */
let recognition=null;
if("webkitSpeechRecognition" in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="en-GB";
  recognition.interimResults=false;
  recognition.continuous=false;
}

function hardStopMic(){
  if(!recognition) return;
  try { recognition.onresult=null; recognition.onerror=null; } catch(e){}
  try { recognition.abort(); } catch(e){}
  try { recognition.stop(); } catch(e){}
}

// starts mic AFTER a safe delay (prevents cutting audio)
function listenOnce(callback){
  if(!recognition){
    status.innerText="Aap ka browser voice support nahi karta.";
    return;
  }
  hardStopMic();
  setTimeout(()=>{
    recognition.onresult = e => callback(e.results[0][0].transcript);
    recognition.onerror = () => {};
    try { recognition.start(); } catch(e){}
  }, MIC_SAFE_DELAY_MS);
}

/* =========================
   AUDIO (TTS) - NEVER CUT
========================= */
let currentAudio = null;
let speaking = false;

function stopAudio(){
  if(currentAudio){
    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
    currentAudio = null;
  }
}

async function speak(text){
  // Strongest protection:
  // 1) stop mic completely
  // 2) stop any previous audio
  hardStopMic();
  stopAudio();

  speaking = true;
  status.innerText = text;

  const res = await fetch(VOICE_API, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  const blob = await res.blob();
  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    audio.onended = () => {
      speaking = false;
      currentAudio = null;
      // small delay helps mobile stability
      setTimeout(resolve, 200);
    };
    audio.onerror = () => {
      speaking = false;
      currentAudio = null;
      resolve();
    };
    audio.play().catch(() => {
      // if autoplay blocked, resolve; user must tap again
      speaking = false;
      currentAudio = null;
      resolve();
    });
  });
}

/* =========================
   RING (1â€“3 realistic)
========================= */
async function ringPhone(){
  const rings = Math.floor(Math.random()*3)+1;
  for(let i=0;i<rings;i++){
    await new Promise(res=>{
      const r = new Audio("ringtone.mp4");
      r.onended = () => setTimeout(res, 450);
      r.play().catch(res);
    });
  }
}

/* =========================
   ROMAN URDU WELCOMES
========================= */
function buildWelcomeFirst(lady,tone){
  const base={
    friendly:[
      `Assalam o Alaikum! DrivePK mein khush aamadid. Main ${lady} hoon.`,
      `Salam! DrivePK se baat ho rahi hai. Main ${lady} hoon.`,
      `Assalam o Alaikum! DrivePK ki taraf se. Main ${lady} hoon.`
    ],
    direct:[
      `Assalam o Alaikum. DrivePK. Main ${lady} hoon.`,
      `Salam. DrivePK se ${lady} baat kar rahi hoon.`,
      `Assalam o Alaikum. Main ${lady} hoon, DrivePK se.`
    ],
    formal:[
      `Assalam o Alaikum. DrivePK mein khush aamadid. Main ${lady} baat kar rahi hoon.`,
      `Assalam o Alaikum. DrivePK se ${lady} hazir hai.`,
      `Assalam o Alaikum. Main ${lady} hoon. Aap ki rehnumai ke liye hazir hoon.`
    ]
  };
  return rand(base[tone]||base.friendly);
}
function buildAskName(tone){
  const asks={
    friendly:["Aap ka naam kya hai?","Main aap ka naam jaan sakti hoon?","Aap apna naam bata dein please."],
    direct:["Aap ka naam?","Naam bata dein.","Naam kya hai?"],
    formal:["Meherbani farma kar apna naam batayein.","Aap apna naam share kar dein please.","Aap ka naam maloom ho sakta hai?"]
  };
  return rand(asks[tone]||asks.friendly);
}
function buildWelcomeReturning(name,lady,tone){
  const base={
    friendly:[
      `${name} bhai, Assalam o Alaikum! Main ${lady} hoon. Aaj kya dhoondhna hai?`,
      `${name} bhai, salam! Main ${lady}. Aap ki kya madad karun?`,
      `${name} bhai, welcome back! Main ${lady} hoon. Kis gaari ki talash hai?`
    ],
    direct:[
      `${name} bhai, salam. Main ${lady}. Aaj ka search bata dein.`,
      `${name} bhai, Assalam o Alaikum. Main ${lady}. Model/year/city bol dein.`,
      `${name} bhai, salam. Main ${lady}. Kya chahiye?`
    ],
    formal:[
      `${name} bhai, Assalam o Alaikum. Main ${lady} hoon. Aap ki khidmat mein hazir hoon.`,
      `${name} bhai, salam. Main ${lady}. Meherbani farma kar apni requirement batayein.`,
      `${name} bhai, Assalam o Alaikum. Main ${lady}. Aap kya dekhna pasand karein ge?`
    ]
  };
  return rand(base[tone]||base.friendly);
}

/* =========================
   NAME (multi-word)
========================= */
function tidyName(raw){
  return raw
    .replace(/[^a-zA-Z\s]/g," ")
    .replace(/\s+/g," ")
    .trim()
    .split(" ")
    .slice(0,3)
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase())
    .join(" ");
}
function extractName(text){
  const t=(text||"").trim();
  let m = t.match(/(my name is|mera naam)\s+(.+)/i);
  if(m) return tidyName(m[2]);
  const cleaned = tidyName(t);
  if(cleaned && cleaned.length >= 2) return cleaned;
  return null;
}

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch(SEARCH_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });
  let json=null;
  try{ json=await res.json(); }catch(e){}
  results.innerHTML="";
  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }
  json.data.forEach(c=>{
    const img=c.images?.[0]||"";
    const price=c.price?Number(c.price).toLocaleString():"Call";
    results.innerHTML += `
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title||"-"}</h3>
        <div>${c.year||"-"} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });
}

function startSearchListening(){
  // ensure audio is not playing before mic
  hardStopMic();
  stopAudio();
  listenOnce(async spoken=>{
    query.value = spoken;
    const p=getProfile();
    p.lastSearch = spoken;
    saveProfile(p);
    await runSearch(spoken);
    status.innerText="Agar dobara bolna ho to ðŸŽ¤ TALK dabayein.";
  });
}

/* =========================
   FLOWS
========================= */
async function firstTimeFlow(lady,tone){
  await speak(buildWelcomeFirst(lady,tone));
  await speak(buildAskName(tone));

  // mic starts AFTER both audios complete + safe delay
  listenOnce(async userText=>{
    const name = extractName(userText);
    if(!name){
      await speak("Maaf kijiye, naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      return firstTimeFlow(lady,tone);
    }
    const p=getProfile();
    p.name=name; p.lady=lady; saveProfile(p);

    await speak(`Shukriya ${name} bhai. Ab aap kis gaari ki talash kar rahe hain?`);
    startSearchListening();
  });
}

async function returningFlow(name,lady,tone){
  await speak(buildWelcomeReturning(name,lady,tone));
  await speak("Aap apni requirement bol dein, jaise model, year aur city.");
  startSearchListening();
}

/* =========================
   UI
========================= */
callBtn.onclick = async () => {
  callBtn.classList.add("calling");
  callBtn.innerText="ðŸ“ž CALLINGâ€¦";
  callBtn.disabled=true;

  // make sure nothing is running
  hardStopMic();
  stopAudio();

  await ringPhone();

  callBtn.classList.remove("calling");
  callBtn.innerText="ðŸŽ¤ TALK";
  callBtn.disabled=false;

  const p=getProfile();
  const lady=getOrAssignLady();
  const tone=getOrAssignTone();

  if(!p.name) await firstTimeFlow(lady,tone);
  else await returningFlow(p.name,lady,tone);
};

searchBtn.onclick = () => {
  const t=query.value.trim();
  if(!t) return;
  const p=getProfile();
  p.lastSearch=t;
  saveProfile(p);
  runSearch(t);
};
</script>
</body>
</html>