<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>

<style>
  body { margin:0; font-family:Arial,sans-serif; background:#e6e6e6; }
  header{ background:#000; color:#fff; padding:10px; display:flex; gap:10px; align-items:center; }
  .logo{ background:#E81F25; width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:bold; }
  .main{ padding:10px; max-width:520px; margin:0 auto; }
  .hero{ background:#000; border-radius:18px; height:22vh; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:10px; }
  .hero h1{ font-size:30px; margin:0; }
  .hero h2{ font-size:14px; color:#E81F25; margin-top:4px; }

  input,button{ width:100%; height:46px; border-radius:12px; font-size:15px; box-sizing:border-box; }
  input{ padding:0 14px; border:1px solid #ccc; margin-bottom:6px; }
  button{ border:none; background:#000; color:#fff; cursor:pointer; }

  .call{ background:#E81F25; font-size:16px; margin-top:6px; user-select:none; transition:filter .08s ease, transform .08s ease; }
  .call.calling{ background:#999; color:#000; }
  .call.talking{ filter:brightness(0.78); transform:scale(0.985); }

  #hint{ margin-top:6px; font-size:12px; color:#333; opacity:0.85; }
  #status{ margin-top:6px; font-weight:bold; color:#E81F25; font-size:14px; }
  #results{ margin-top:10px; }

  .car{ background:#fff; border-radius:12px; padding:8px; margin-bottom:10px; }
  .car img{ width:100%; height:140px; object-fit:cover; border-radius:8px; }

  #supportBox{
    display:none;
    margin-top:10px;
    background:#fff;
    border-radius:12px;
    padding:10px;
  }
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Vitz 2017 Lahore" />
  <button id="searchBtn">Search</button>

  <button class="call" id="callBtn">üìû CALL</button>
  <div id="hint">Call dabayen. Phir üé§ ko press & hold karke bolen.</div>

  <div id="status"></div>

  <div id="supportBox">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px; font-size:18px; color:#E81F25; font-weight:bold;">051 8319037</div>
    <div style="margin-top:4px; font-size:12px; opacity:0.8;">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<script>
/* ================================
   DrivePK BOLO ‚Äì single file
   Fixes requested:
   ‚úÖ One single greeting (no pause) + same lady voice
   ‚úÖ Greeting text: ‚ÄúKia main aap ka naam pooch sakti hoon?‚Äù
   ‚úÖ If search returns 0 results: speak ‚ÄúKoi gaari available nahi‚Äù
   ‚úÖ If search returns results: speak a results line
================================ */

const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const COMPANY_NUMBER = "051 8319037";

const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];

const VOICE_BY_LADY = {
  "Kiran":    { voice:"marin",  speed:0.95 },
  "Reshma":   { voice:"cedar",  speed:0.95 },
  "Mahnoor":  { voice:"shimmer",speed:0.98 },
  "Gul Noor": { voice:"coral",  speed:0.95 },
  "Dil Bahar":{ voice:"nova",   speed:0.98 },
  "Shaheen":  { voice:"sage",   speed:0.95 }
};
const BOSS_UMAR = { voice:"onyx", speed:0.95 };

const RESULT_LINES = [
  "Jee, aap ke results aa gaye hain.",
  "Acha jee, yeh aap ke results hain.",
  "Theek hai, matching gaariyan mil gayi hain.",
  "Results aa gaye ‚Äî aap options dekh sakte hain.",
  "Yeh rahi aap ki search results."
];

const NO_RESULT_LINES = [
  "Is search par koi gaari available nahi.",
  "Maazrat, is waqt koi matching gaari nahi mili.",
  "Acha, is city mein filhaal koi option nazar nahi aa raha.",
  "Koi gaari nahi mili ‚Äî aap model ya city change karke try karein."
];

const SILENCE_MS = 5000;
const END_WAIT_MS = 700;

let callConnected = false;
let recognition = null;
let isRecognizing = false;
let transcript = "";
let silenceTimer = null;
let micReady = false;

let currentAudio = null;
let speakSeq = 0;
let holding = false;

function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randLady(){ return LADIES[Math.floor(Math.random()*LADIES.length)]; }

function getOrAssignLady(){
  const p = getProfile();
  if(!p.lady){
    p.lady = randLady();
    saveProfile(p);
  }
  return p.lady;
}

function setStatus(t){ status.innerText = t || ""; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function clearSilence(){ if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; } }
function showSupport(){ supportBox.style.display="block"; }
function hideSupport(){ supportBox.style.display="none"; }
function normalize(t){ return (t||"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim(); }

function respectfulName(profile){
  if(!profile || !profile.name) return "bhai";
  const nm = profile.name.trim();
  if(nm.toLowerCase().startsWith("dr")) return "Dr sahib";
  return nm.split(" ")[0] + " bhai";
}

function extractName(text){
  const t = (text||"").trim();
  const m = t.match(/(my name is|mera naam)\s+(.+)/i);
  let raw = m ? m[2] : t;
  raw = raw.replace(/[^a-zA-Z\s]/g," ").replace(/\s+/g," ").trim();
  if(!raw) return null;
  const parts = raw.split(" ").slice(0,3);
  return parts.map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
}

function getLadyVoicePack(){
  const p = getProfile();
  const lady = p.lady || getOrAssignLady();
  return VOICE_BY_LADY[lady] || { voice:"marin", speed:0.95 };
}

function stopAllVoiceEngines(){
  if(currentAudio){
    try{ currentAudio.pause(); currentAudio.currentTime = 0; }catch(e){}
    currentAudio = null;
  }
  try{ window.speechSynthesis && window.speechSynthesis.cancel(); }catch(e){}
}

async function warmupMic(){
  if(micReady) return true;
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    micReady = true;
    return true;
  }catch{
    return false;
  }
}

function stopMic(){
  if(!recognition) return;
  try{ recognition.onresult=null; recognition.onerror=null; recognition.onend=null; }catch(e){}
  try{ recognition.abort(); }catch(e){}
  try{ recognition.stop(); }catch(e){}
  isRecognizing = false;
  clearSilence();
}

/* speak with chosen voicePack */
async function speak(text, voicePack=null){
  const mySeq = ++speakSeq;

  stopMic();
  stopAllVoiceEngines();
  clearSilence();

  setStatus(text);

  const vp = voicePack || getLadyVoicePack();

  let res;
  try{
    res = await fetch(VOICE_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        text,
        voice: vp.voice,
        speed: vp.speed
      })
    });
  }catch{
    return;
  }

  if(!res || !res.ok) return;

  const blob = await res.blob();
  if(mySeq !== speakSeq) return;

  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    const done = ()=>{ if(mySeq===speakSeq) currentAudio=null; resolve(); };
    audio.onended = done;
    audio.onerror = done;
    audio.play().catch(done);
  });
}

async function ring(){
  const times = Math.floor(Math.random()*3)+1;
  for(let i=0;i<times;i++){
    await new Promise(r=>{
      const a = new Audio("ringtone.mp4");
      a.onended = ()=>setTimeout(r,350);
      a.play().catch(r);
    });
  }
}

if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-IN";
  recognition.interimResults = false;
  recognition.continuous = false;
}

async function startListening(){
  if(!callConnected) return;
  if(holding) return;
  holding = true;

  stopAllVoiceEngines();
  hideSupport();

  if(!recognition){
    holding = false;
    await speak("Mic supported nahi hai. Please type karke search karein.");
    return;
  }

  const ok = await warmupMic();
  if(!ok){
    holding = false;
    await speak("Mic permission allow nahi. Please type kar dein.");
    return;
  }

  transcript = "";
  isRecognizing = true;

  callBtn.classList.add("talking");
  callBtn.innerText = "üéô LISTENING‚Ä¶";
  setStatus("Sun rahi hoon‚Ä¶ (hold rakhein)");

  clearSilence();
  silenceTimer = setTimeout(async ()=>{
    if(isRecognizing && !transcript){
      const p = getProfile();
      await speak(`${respectfulName(p)}, model, year aur city bol dein.`);
    }
  }, SILENCE_MS);

  recognition.onresult = e=>{
    transcript = e?.results?.[0]?.[0]?.transcript || "";
  };
  recognition.onend = ()=>{
    isRecognizing = false;
    clearSilence();
  };

  try{ recognition.start(); }catch(e){
    holding = false;
    isRecognizing = false;
    clearSilence();
  }
}

async function stopListening(){
  if(!holding) return;
  holding = false;

  callBtn.classList.remove("talking");
  callBtn.innerText = "üé§ HOLD TO TALK";

  if(!recognition || !isRecognizing) return;

  clearSilence();
  try{ recognition.stop(); }catch(e){}
  await sleep(END_WAIT_MS);

  const spoken = (transcript || "").trim();
  if(!spoken){
    await speak("Awaaz clear nahi aayi. Dobara bolen ya type karein.");
    return;
  }
  await handleSpoken(spoken);
}

/* intents */
function wantsComplaint(t){
  t = normalize(t);
  return ["complaint","complain","shikayat","issue","problem","masla","support","customer care","number"].some(x=>t.includes(x));
}
function wantsBoss(t){
  t = normalize(t);
  return ["boss","manager","supervisor","owner","boss se baat","boss se milao","boss se baat karwao","mujhe boss se baat karni hai","umar","umar se baat"].some(x=>t.includes(x));
}
function wantsNewLady(t){
  t = normalize(t);
  return ["change lady","switch lady","another lady","other lady","dusri madam","dusri lady","aur madam chahiye","koi aur lady","dusri madam se baat karwao","koi khoobsurat lady chahiye"].some(x=>t.includes(x));
}
function isAskingMyName(t){
  t = normalize(t);
  return t.includes("your name") || t.includes("aap ka naam") || t.includes("ap ka naam") || t.includes("naam kya");
}

/* main router */
async function handleSpoken(text){
  const p = getProfile();
  const who = respectfulName(p);

  // first-time: take name
  if(!p.name){
    if(isAskingMyName(text)){
      const lady = p.lady || getOrAssignLady();
      await speak(`Mera naam ${lady} hai. Kia main aap ka naam pooch sakti hoon?`);
      return;
    }
    const nm = extractName(text);
    if(!nm){
      await speak("Naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      return;
    }
    p.name = nm;
    saveProfile(p);
    await speak(`Shukriya ${respectfulName(p)}. Ab apni requirement bol dein.`);
    return;
  }

  // complaint
  if(wantsComplaint(text)){
    showSupport();
    await speak(`${who}, complaint ke liye please is number par call karein: ${COMPANY_NUMBER}.`);
    return;
  } else {
    hideSupport();
  }

  // boss (Umar male voice)
  if(wantsBoss(text)){
    await speak(`${who}, theek hai. Main aap ko Umar se connect kar raha hoon.`, BOSS_UMAR);
    await speak(`${who}, Assalam o Alaikum. Main Umar hoon. Aap ka masla kya hai?`, BOSS_UMAR);
    return;
  }

  // change lady
  if(wantsNewLady(text)){
    const current = p.lady || getOrAssignLady();
    const others = LADIES.filter(x=>x!==current);
    p.lady = rand(others.length ? others : LADIES);
    saveProfile(p);

    const newLady = p.lady;
    await speak(`${who}, theek hai. Ab ${newLady} baat karegi.`);
    await speak(`Assalam o Alaikum ${who}. Main ${newLady} hoon. Kia main aap ka naam pooch sakti hoon?`);
    return;
  }

  // assistant name
  if(isAskingMyName(text)){
    const lady = p.lady || getOrAssignLady();
    await speak(`${who}, mera naam ${lady} hai.`);
    return;
  }

  // otherwise search
  query.value = text;
  const count = await runSearch(text);

  // ‚úÖ Speak based on results count
  if(count > 0){
    await speak(rand(RESULT_LINES));
  }else{
    await speak(rand(NO_RESULT_LINES));
  }
}

/* search returns count */
async function runSearch(text){
  hideSupport();
  results.innerHTML = "<p>Gaariyan dhoondi ja rahi hain‚Ä¶</p>";

  let res;
  try{
    res = await fetch(SEARCH_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text })
    });
  }catch{
    results.innerHTML = "<p>Search error</p>";
    return 0;
  }

  let json=null;
  try{ json = await res.json(); }catch(e){}

  results.innerHTML = "";
  if(!json || !json.data || !json.data.length){
    results.innerHTML = "<p>Koi gaari nahi mili</p>";
    return 0;
  }

  json.data.forEach(c=>{
    const img = c.images?.[0] || "";
    const price = c.price ? Number(c.price).toLocaleString() : "Call";
    const title = c.title || "-";
    const year = c.year || "-";
    const city = c.location?.city || "-";

    results.innerHTML += `
      <div class="car">
        ${img ? `<img src="${img}">` : ""}
        <h3>${title}</h3>
        <div>${year} ‚Ä¢ ${city}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });

  return json.data.length;
}

/* call flow */
async function connectCall(){
  stopAllVoiceEngines();
  stopMic();
  hideSupport();

  callBtn.classList.add("calling");
  callBtn.innerText = "üìû CALLING‚Ä¶";
  callBtn.disabled = true;

  await ring();

  callConnected = true;
  callBtn.classList.remove("calling");
  callBtn.disabled = false;
  callBtn.innerText = "üé§ HOLD TO TALK";
  hint.innerText = "üé§ Press & hold karke bolen.";

  const p = getProfile();
  const lady = getOrAssignLady();

  // ‚úÖ SINGLE greeting line (no pause / no voice switch)
  if(!p.name){
    await speak(`Assalam o Alaikum! DrivePK mein khush aamadid. Mera naam ${lady} hai. Kia main aap ka naam pooch sakti hoon?`);
  }else{
    await speak(`${respectfulName(p)}, Assalam o Alaikum. Model, year aur city bol dein.`);
  }

  // warm mic so first press works
  await warmupMic();
}

/* events */
hideSupport();
setStatus("");
hint.innerText = "Call dabayen. Phir üé§ ko press & hold karke bolen.";

callBtn.addEventListener("click", async ()=>{
  if(!callConnected) await connectCall();
});

callBtn.addEventListener("pointerdown", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  try{ callBtn.setPointerCapture(e.pointerId); }catch(e){}
  startListening();
});
callBtn.addEventListener("pointerup", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});
callBtn.addEventListener("pointercancel", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

searchBtn.addEventListener("click", async ()=>{
  const t = (query.value || "").trim();
  if(!t) return;
  const count = await runSearch(t);
  if(count > 0) await speak(rand(RESULT_LINES));
  else await speak(rand(NO_RESULT_LINES));
});
</script>
</body>
</html>
```Ó®Å0Ó®Ç