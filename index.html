<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>

<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e6e6e6;}
  header{background:#000;color:#fff;padding:10px;display:flex;gap:10px;align-items:center;}
  .logo{background:#E81F25;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;}
  .main{padding:10px;max-width:520px;margin:0 auto;}
  .hero{background:#000;border-radius:18px;height:22vh;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:10px;}
  .hero h1{font-size:30px;margin:0;}
  .hero h2{font-size:14px;color:#E81F25;margin-top:4px;}

  input,button{width:100%;height:46px;border-radius:12px;font-size:15px;box-sizing:border-box;}
  input{padding:0 14px;border:1px solid #ccc;margin-bottom:6px;}
  button{border:none;background:#000;color:#fff;cursor:pointer;}

  .row{display:flex;gap:8px;}
  .row button{flex:1;}

  .call{background:#E81F25;font-size:16px;margin-top:6px;user-select:none;transition:filter .08s ease,transform .08s ease;}
  .call.calling{background:#999;color:#000;}
  .call.talking{filter:brightness(0.78);transform:scale(0.985);}

  #hint{margin-top:6px;font-size:12px;color:#333;opacity:.85;}
  #status{margin-top:6px;font-weight:bold;color:#E81F25;font-size:14px;}
  #results{margin-top:10px;}

  .card{background:#fff;border-radius:12px;padding:10px;margin-bottom:10px;}
  .car{background:#fff;border-radius:12px;padding:8px;margin-bottom:10px;cursor:pointer;}
  .car img{width:100%;height:140px;object-fit:cover;border-radius:8px;}

  .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;}
  .muted{opacity:.75;font-size:12px;}
  .btnRed{background:#E81F25 !important;}

  #supportBox{display:none;margin-top:10px;background:#fff;border-radius:12px;padding:10px;}

  .modalBack{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; z-index:9999;
    padding:12px;
  }
  .modal{
    width:100%; max-width:420px; background:#fff; border-radius:14px; padding:12px;
  }
  .modal h3{margin:0 0 8px 0;}
  .modal .row2{display:flex; gap:8px; margin-top:8px;}
  .modal .row2 button{flex:1; height:44px;}
  .xbtn{float:right;background:#eee;color:#000;width:40px;height:36px;border-radius:10px;}
  .small{font-size:12px; opacity:.8; margin-top:6px;}
  .ok{color:#0a7a2f; font-weight:bold;}
  .bad{color:#b00020; font-weight:bold;}

  #detailPage{
    position:fixed; inset:0; background:#fff; z-index:999; display:none; overflow-y:auto;
  }
  .detailHeader{
    background:#000;color:#fff;padding:10px;display:flex;align-items:center;gap:10px;position:sticky;top:0;
  }
  .detailHeader button{background:#E81F25;border-radius:10px;padding:8px 10px;color:#fff;}
  .galleryWrap{background:#000;position:relative;}
  .gallery{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;}
  .gallery img{width:100%;height:240px;object-fit:cover;scroll-snap-align:start;flex-shrink:0;border-right:6px solid #000;}
  .swipe{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;}
  .detailBody{padding:12px;}
  .price{font-size:22px;font-weight:bold;margin:6px 0 12px 0;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
  .box{background:#111;color:#fff;border-radius:12px;padding:10px 6px;text-align:center;font-size:13px;}
  .box strong{display:block;font-size:15px;margin-top:4px;}
  .contactBox{background:#000;color:#fff;border-radius:14px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .contactBtn{background:#E81F25;color:#fff;border-radius:12px;padding:10px 12px;font-weight:bold;min-width:140px;text-align:center;}
  .lock{opacity:.7;font-size:13px;}
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br />
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: Black Honda City Lahore over 20 lakh" />
  <div class="row">
    <button id="searchBtn">Search</button>
    <button id="authBtn" class="btnRed">Login</button>
  </div>

  <button class="call" id="callBtn">CALL</button>
  <div id="hint">Call dabayen. Phir mic ko press & hold karke bolen.</div>

  <div id="status"></div>

  <div id="supportBox" class="card">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px;font-size:18px;color:#E81F25;font-weight:bold;">0300 8319037</div>
    <div class="small">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<!-- DETAIL PAGE -->
<div id="detailPage">
  <div class="detailHeader">
    <button id="backBtn">‚Üê Back</button>
    <strong id="detailTitle"></strong>
  </div>

  <div class="galleryWrap">
    <div class="gallery" id="gallery"></div>
    <div class="swipe">Swipe ‚á† ‚á¢</div>
  </div>

  <div class="detailBody">
    <div class="price" id="detailPrice"></div>
    <div class="grid" id="specGrid"></div>

    <div class="contactBox">
      <div>
        <div class="lock" id="contactHint">üîí Login to view phone number</div>
        <div class="muted" id="sellerName"></div>
      </div>
      <div class="contactBtn" id="contactBtn">Contact Seller</div>
    </div>

    <div id="phoneBox" class="card" style="display:none;margin-top:10px;">
      <div class="pill">Contact</div>
      <div style="margin-top:6px;font-size:20px;font-weight:bold;color:#E81F25;" id="realPhone"></div>
      <div class="small" id="phoneOwner"></div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <button class="xbtn" id="closeModal">‚úï</button>
    <h3 id="modalTitle">Login</h3>

    <div id="modalMsg" class="small"></div>

    <div id="loginForm">
      <!-- ‚úÖ Email OR Phone -->
      <input id="loginId" placeholder="Email or Phone (03008319037)" />
      <input id="loginPass" placeholder="Password" type="password" />
      <div class="row2">
        <button id="doLogin" class="btnRed">Login</button>
        <button id="goRegister">Register</button>
      </div>
      <div class="small">Email ya phone se login ho jata hai.</div>
    </div>

    <div id="registerForm" style="display:none;">
      <input id="regName" placeholder="Full Name" />
      <input id="regEmail" placeholder="Email" />
      <input id="regPhone" placeholder="Phone (3001234567)" />
      <input id="regPass" placeholder="Password (Password123)" type="password" />
      <input id="regPass2" placeholder="Confirm Password" type="password" />
      <div class="row2">
        <button id="doRegister" class="btnRed">Create</button>
        <button id="goLogin">Back</button>
      </div>
    </div>

    <div id="loggedInBox" style="display:none;">
      <div class="card">
        <div class="pill">Logged In</div>
        <div style="margin-top:6px;font-weight:bold;" id="whoami"></div>
        <div class="small" id="whoEmail"></div>
      </div>
      <button id="logoutBtn" style="background:#000;margin-top:8px;">Logout</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API  = "voice.php";
const GATEWAY_API = "search.php";
const COMPANY_NUMBER = "0300 8319037";
const WEBSITE = "www.drivepk.com";
const OFFICE_ADDRESS = "195, Peshawar Road, Chur Chowk Beside PSO Pump, Westridge, Rawalpindi.";

const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const VOICE_BY_LADY = {
  "Kiran":    { voice:"marin",   speed:0.95 },
  "Reshma":   { voice:"cedar",   speed:0.95 },
  "Mahnoor":  { voice:"shimmer", speed:0.98 },
  "Gul Noor": { voice:"coral",   speed:0.95 },
  "Dil Bahar":{ voice:"nova",    speed:0.98 },
  "Shaheen":  { voice:"sage",    speed:0.95 }
};

// ‚úÖ Boss Umar voice changed to onyx
const BOSS_UMAR = { voice:"onyx", speed:0.95 };

const RESULT_LINES = [
  "Jee Bhai jaan, yeh aap ke search results hain.",
  "Acha Bhai jaan, results aa gaye hain.",
  "Theek hai Bhai jaan, matching gaariyan mil gayi hain.",
  "Bhai jaan, yeh rahi aap ki search results."
];
const NO_RESULT_LINES = [
  "Bhai jaan, is search par koi gaari available nahi.",
  "Maazrat Bhai jaan, is waqt koi matching gaari nahi mili.",
  "Bhai jaan, koi gaari nahi mili, aap model ya city change karke try karein."
];
const UNKNOWN_LINES = [
  "Sorry Bhai jaan, abhi mujhe is ka jawab maloom nahi hai.",
  "Bhai jaan, main sirf gaari search mein help karti hoon. Aap car ka model, year aur city bol dein.",
  "Maazrat Bhai jaan, is cheez mein help nahi ho pa rahi. Aap gaari ka brand aur city batayein."
];

const SILENCE_MS = 5000;
const END_WAIT_MS = 900;
const MIN_HOLD_MS = 400;
const PAGE_SIZE = 20;

/* =========================
   STATE
========================= */
let callConnected = false;
let recognition = null;
let isRecognizing = false;
let transcript = "";
let silenceTimer = null;
let micReady = false;

let currentAudio = null;
let speakSeq = 0;

let holding = false;
let holdStartTs = 0;
let micFailCount = 0;

let lastResults = [];
let currentCar = null;

let currentSearchText = "";
let currentPage = 1;
let hasMore = true;
let isLoadingMore = false;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }

function getTokens(){
  return {
    access: localStorage.getItem("dp_access") || "",
    refresh: localStorage.getItem("dp_refresh") || "",
    expiresAt: parseInt(localStorage.getItem("dp_expiresAt") || "0", 10) || 0,
    user: JSON.parse(localStorage.getItem("dp_user") || "null")
  };
}
function setTokens(data){
  if(!data) return;
  if(data.access_token) localStorage.setItem("dp_access", data.access_token);
  if(data.refresh_token) localStorage.setItem("dp_refresh", data.refresh_token);
  if(typeof data.expires_in === "number"){
    localStorage.setItem("dp_expiresAt", String(Date.now() + (data.expires_in*1000) - 5000));
  }
  if(data.user) localStorage.setItem("dp_user", JSON.stringify(data.user));
}
function clearTokens(){
  localStorage.removeItem("dp_access");
  localStorage.removeItem("dp_refresh");
  localStorage.removeItem("dp_expiresAt");
  localStorage.removeItem("dp_user");
}

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function setStatus(t){ $("status").innerText = t || ""; }
function clearSilence(){ if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; } }
function showSupport(){ $("supportBox").style.display = "block"; }
function hideSupport(){ $("supportBox").style.display = "none"; }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randLady(){ return LADIES[Math.floor(Math.random()*LADIES.length)]; }
function normalize(t){ return (t||"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim(); }

// ‚úÖ Always address as Bhai jaan
function respectfulName(){ return "Bhai jaan"; }

function getOrAssignLady(){
  const p = getProfile();
  if(!p.lady){ p.lady = randLady(); saveProfile(p); }
  return p.lady;
}

/* =========================
   VOICE
========================= */
function stopAllVoice(){
  if(currentAudio){
    try{ currentAudio.pause(); currentAudio.currentTime = 0; }catch(e){}
    currentAudio = null;
  }
}
function stopMic(){
  if(!recognition) return;
  try{ recognition.onresult=null; recognition.onerror=null; recognition.onend=null; }catch(e){}
  try{ recognition.abort(); }catch(e){}
  try{ recognition.stop(); }catch(e){}
  isRecognizing = false;
  clearSilence();
}
async function warmupMic(){
  if(micReady) return true;
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    micReady = true;
    return true;
  }catch{ return false; }
}
async function speak(text, voicePack){
  const mySeq = ++speakSeq;
  stopMic();
  stopAllVoice();
  clearSilence();
  setStatus(text);

  const p = getProfile();
  const lady = p.lady || getOrAssignLady();
  const vp = voicePack || (VOICE_BY_LADY[lady] || { voice:"marin", speed:0.95 });
  const safeSpeed = Number((vp.speed || 0.95).toFixed(2));

  let res;
  try{
    res = await fetch(VOICE_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, voice: vp.voice, speed: safeSpeed })
    });
  }catch{ return; }

  if(!res || !res.ok) return;

  const blob = await res.blob();
  if(mySeq !== speakSeq) return;

  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    const done = ()=>{ if(mySeq===speakSeq) currentAudio=null; resolve(); };
    audio.onended = done;
    audio.onerror = done;
    audio.play().catch(done);
  });
}
async function ring(){
  const times = Math.floor(Math.random()*3)+1;
  for(let i=0;i<times;i++){
    await new Promise(r=>{
      const a = new Audio("ringtone.mp4");
      a.onended = ()=>setTimeout(r,350);
      a.play().catch(r);
    });
  }
}

if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-IN";
  recognition.interimResults = true;
  recognition.continuous = true;
}

async function startListening(){
  if(!callConnected || holding) return;
  holding = true;
  holdStartTs = Date.now();

  stopAllVoice();
  hideSupport();

  if(!recognition){
    holding = false;
    await speak("Mic supported nahi hai Bhai jaan. Please type karke search karein.");
    return;
  }

  const ok = await warmupMic();
  if(!ok){
    holding = false;
    await speak("Mic permission allow nahi Bhai jaan. Please type kar dein.");
    return;
  }

  transcript = "";
  isRecognizing = true;

  const btn = $("callBtn");
  btn.classList.add("talking");
  btn.innerText = "LISTENING...";

  setStatus("Sun rahi hoon Bhai jaan...");

  clearSilence();
  silenceTimer = setTimeout(async ()=>{
    if(isRecognizing && !transcript){
      await speak("Bhai jaan, model, year, city, color ya budget bol dein.");
    }
  }, SILENCE_MS);

  recognition.onresult = (e)=>{
    try{
      let last = "";
      for(let i=0;i<e.results.length;i++){
        const r = e.results[i];
        if(r && r[0] && r[0].transcript) last = r[0].transcript;
      }
      if(last) transcript = last;
    }catch(err){}
  };
  recognition.onerror = ()=>{ isRecognizing=false; clearSilence(); };
  recognition.onend = ()=>{ isRecognizing=false; clearSilence(); };

  try{ recognition.start(); }catch(e){
    holding=false; isRecognizing=false; clearSilence();
  }
}

async function stopListening(){
  if(!holding) return;
  holding = false;

  const btn = $("callBtn");
  btn.classList.remove("talking");
  btn.innerText = "HOLD TO TALK";

  if(!recognition || !isRecognizing) return;

  const heldMs = Date.now() - holdStartTs;
  if(heldMs < MIN_HOLD_MS) await new Promise(r=>setTimeout(r, MIN_HOLD_MS - heldMs));

  clearSilence();
  try{ recognition.stop(); }catch(e){}
  await new Promise(r=>setTimeout(r, END_WAIT_MS));

  const spoken = (transcript || "").trim();
  if(!spoken){
    micFailCount++;
    if(micFailCount === 1) await speak("Awaaz clear nahi aayi Bhai jaan. Press karke hold rakhein, bol kar release karein.");
    else await speak("Lagta hai mic record nahi kar raha Bhai jaan. Aap type karke bhi likh sakte hain.");
    return;
  }

  micFailCount = 0;
  await handleSpoken(spoken);
}

/* =========================
   GATEWAY CALLS
========================= */
async function gateway(payload){
  const res = await fetch(GATEWAY_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  let json = null;
  try{ json = await res.json(); }catch(e){}
  return { ok: res.ok, status: res.status, json };
}

/* =========================
   SEARCH + INFINITE SCROLL
========================= */
async function runSearch(text){
  hideSupport();
  $("results").innerHTML = "";
  lastResults = [];

  currentSearchText = text;
  currentPage = 1;
  hasMore = true;
  isLoadingMore = false;

  $("results").innerHTML = "<div class='card'>Searching...</div>";
  const firstCount = await loadMoreResults(true);

  if(firstCount > 0) return firstCount;
  $("results").innerHTML = "<div class='card'>No cars available</div>";
  return 0;
}

async function loadMoreResults(isFirst=false){
  if(isLoadingMore || !hasMore) return 0;
  isLoadingMore = true;

  if(!isFirst){
    const loader = document.createElement("div");
    loader.id = "loaderMore";
    loader.className = "card";
    loader.innerHTML = "Loading more cars...";
    $("results").appendChild(loader);
  }

  const r = await gateway({
    action:"search",
    text: currentSearchText,
    page: currentPage,
    limit: PAGE_SIZE
  });

  const lm = document.getElementById("loaderMore");
  if(lm) lm.remove();

  const json = r.json || {};
  const newData = json.data || [];
  hasMore = (typeof json.hasMore === "boolean") ? json.hasMore : false;

  if(isFirst) $("results").innerHTML = "";

  newData.forEach((c)=>{
    lastResults.push(c);
    const idx = lastResults.length - 1;

    const img = (c.images && c.images[0]) ? c.images[0] : "";
    const price = c.price ? Number(c.price).toLocaleString() : "Call";
    const title = c.title || "-";
    const year = c.year || "-";
    const city = (c.location && c.location.city) ? c.location.city : "-";

    const wrap = document.createElement("div");
    wrap.className = "car";
    wrap.onclick = ()=>openDetail(idx);
    wrap.innerHTML = `
      ${img ? `<img src="${img}" loading="lazy">` : ""}
      <h3 style="margin:8px 0 4px 0;">${title}</h3>
      <div class="muted">${year} ‚Ä¢ ${city}</div>
      <strong>PKR ${price}</strong>
    `;
    $("results").appendChild(wrap);
  });

  if(newData.length > 0) currentPage++;
  isLoadingMore = false;
  return newData.length;
}

window.addEventListener("scroll", async ()=>{
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 450);
  if(nearBottom && currentSearchText){
    await loadMoreResults(false);
  }
});

/* Detail */
window.openDetail = function(i){
  currentCar = lastResults[i];
  if(!currentCar) return;

  $("detailPage").style.display = "block";
  $("detailTitle").innerText = currentCar.title || "Car Detail";
  $("detailPrice").innerText = "PKR " + (currentCar.price ? Number(currentCar.price).toLocaleString() : "Call");

  $("gallery").innerHTML = "";
  (currentCar.images || []).forEach(u=>{ $("gallery").innerHTML += `<img src="${u}">`; });

  $("specGrid").innerHTML = `
    <div class="box">Year<strong>${currentCar.year || "-"}</strong></div>
    <div class="box">City<strong>${(currentCar.location && currentCar.location.city) ? currentCar.location.city : "-"}</strong></div>
    <div class="box">Mileage<strong>${currentCar.mileage ? (currentCar.mileage + " km") : "-"}</strong></div>
    <div class="box">Fuel<strong>${currentCar.fuelType || "-"}</strong></div>
    <div class="box">Trans<strong>${currentCar.transmission || "-"}</strong></div>
    <div class="box">Seats<strong>${currentCar.seatingCapacity || "-"}</strong></div>
  `;

  $("contactHint").innerText = getTokens().access ? "Tap to view phone" : "üîí Login to view phone number";
};
$("backBtn").onclick = ()=>{ $("detailPage").style.display = "none"; };

$("contactBtn").onclick = async ()=>{ await speak("Bhai jaan, phone number module abhi connect nahi hai."); };

/* =========================
   TALK ROUTER
========================= */
function wantsComplaint(t){
  t = normalize(t);
  return ["complaint","complain","shikayat","issue","problem","masla","support","customer care"].some(x=>t.includes(x));
}
function isAskingAddress(t){
  t = normalize(t);
  return t.includes("address") || t.includes("office") || t.includes("location") || t.includes("kidhar") || t.includes("kahan") || t.includes("pata");
}
function isAskingPhone(t){
  t = normalize(t);
  return t.includes("phone") || t.includes("number") || t.includes("contact") || t.includes("whatsapp");
}
function isAskingWebsite(t){
  t = normalize(t);
  return t.includes("website") || t.includes("site") || t.includes("url") || t.includes("link");
}
function wantsBoss(t){
  t = normalize(t);
  return ["boss","manager","supervisor","owner","boss se baat","boss se milao","boss se baat karwao","umar","umar se baat"].some(x=>t.includes(x));
}
function wantsNewLady(t){
  t = normalize(t);
  return ["change lady","switch lady","another lady","other lady","dusri madam","dusri lady","koi aur lady"].some(x=>t.includes(x));
}

async function handleSpoken(text){
  const who = respectfulName();

  if(isAskingAddress(text)){ await speak(who + ", hamara office address hai: " + OFFICE_ADDRESS); return; }
  if(isAskingPhone(text)){ showSupport(); await speak(who + ", contact number hai: " + COMPANY_NUMBER + ". WhatsApp bhi isi par hai."); return; }
  if(isAskingWebsite(text)){ await speak(who + ", hamari website hai: " + WEBSITE); return; }

  if(wantsComplaint(text)){
    showSupport();
    await speak(who + ", complaint ke liye please is number par call karein: " + COMPANY_NUMBER + ".");
    return;
  } else hideSupport();

  if(wantsBoss(text)){
    await speak(who + ", theek hai. Main aap ko Umar se connect kar rahi hoon.");
    await ring();
    // ‚úÖ Boss line changed
    await speak("Assalam o Alaikum " + who + ". How may I help you?", BOSS_UMAR);
    return;
  }

  if(wantsNewLady(text)){
    const p = getProfile();
    const cur = p.lady || getOrAssignLady();
    const others = LADIES.filter(x=>x!==cur);
    p.lady = others.length ? others[Math.floor(Math.random()*others.length)] : randLady();
    saveProfile(p);
    await speak("Theek hai " + who + ". Ab " + p.lady + " baat karegi, " + who + ".");
    return;
  }

  $("query").value = text;
  const count = await runSearch(text);
  if(count > 0) await speak(rand(RESULT_LINES));
  else await speak(rand(NO_RESULT_LINES));
}

/* =========================
   CONNECT CALL
========================= */
async function connectCall(){
  stopAllVoice();
  stopMic();
  hideSupport();

  const btn = $("callBtn");
  btn.classList.add("calling");
  btn.innerText = "CALLING...";
  btn.disabled = true;

  await ring();

  callConnected = true;
  btn.classList.remove("calling");
  btn.disabled = false;
  btn.innerText = "HOLD TO TALK";
  $("hint").innerText = "Press & hold and speak.";

  const lady = getOrAssignLady();

  // ‚úÖ New Urdu line as requested
  await speak("Assalam o Alaikum! DrivePK mein khush aamadid. Mera naam " + lady + " hai. Bhai jaan, main aap ki kya madad karo?");

  await warmupMic();
}

/* =========================
   AUTH MODAL UI + LOGIN (Email OR Phone)
========================= */
function openAuthModal(){
  $("modalBack").style.display = "flex";
  renderAuthState();
}
function closeAuthModal(){
  $("modalBack").style.display = "none";
  $("modalMsg").innerHTML = "";
}
function setModalMsg(ok, msg){
  $("modalMsg").innerHTML = `<span class="${ok?'ok':'bad'}">${msg}</span>`;
}
function renderAuthState(){
  const t = getTokens();
  if(t.access){
    $("modalTitle").innerText = "Account";
    $("loginForm").style.display = "none";
    $("registerForm").style.display = "none";
    $("loggedInBox").style.display = "block";
    const u = t.user || {};
    $("whoami").innerText = u.full_name || u.name || "Logged in";
    $("whoEmail").innerText = u.email || u.phone || "";
    $("authBtn").innerText = "Account";
  }else{
    $("modalTitle").innerText = "Login";
    $("loginForm").style.display = "block";
    $("registerForm").style.display = "none";
    $("loggedInBox").style.display = "none";
    $("authBtn").innerText = "Login";
  }
}

// login/register via gateway (search.php must support these actions)
async function doLogin(identifier, password){
  // If identifier looks like phone, normalize
  const idTrim = (identifier || "").trim();
  const isPhone = /^[0-9+ ]{10,15}$/.test(idTrim.replace(/\s+/g,""));
  const payload = { action:"login", password };
  if(isPhone) payload.phone = idTrim.replace(/\s+/g,"");
  else payload.email = idTrim;

  const r = await gateway(payload);
  if(r.ok && r.json && r.json.success && r.json.data){
    setTokens(r.json.data);
    return { ok:true, msg:r.json.message || "Login successful" };
  }
  return { ok:false, msg:(r.json && r.json.message) ? r.json.message : "Login failed" };
}

function showSupport(){ $("supportBox").style.display = "block"; }
function hideSupport(){ $("supportBox").style.display = "none"; }

/* =========================
   EVENTS
========================= */
$("callBtn").addEventListener("click", async ()=>{ if(!callConnected) await connectCall(); });

$("callBtn").addEventListener("pointerdown", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  try{ e.target.setPointerCapture(e.pointerId); }catch(err){}
  startListening();
});
$("callBtn").addEventListener("pointerup", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});
$("callBtn").addEventListener("pointercancel", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

$("searchBtn").addEventListener("click", async ()=>{
  const t = ($("query").value || "").trim();
  if(!t) return;
  const count = await runSearch(t);
  if(count > 0) await speak(rand(RESULT_LINES));
  else await speak(rand(NO_RESULT_LINES));
});

$("authBtn").addEventListener("click", ()=> openAuthModal());
$("closeModal").addEventListener("click", closeAuthModal);
$("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeAuthModal(); });

$("goRegister").addEventListener("click", ()=>{
  $("modalTitle").innerText = "Register";
  $("loginForm").style.display = "none";
  $("registerForm").style.display = "block";
  $("loggedInBox").style.display = "none";
  $("modalMsg").innerHTML = "";
});
$("goLogin").addEventListener("click", ()=>{
  $("modalTitle").innerText = "Login";
  $("loginForm").style.display = "block";
  $("registerForm").style.display = "none";
  $("loggedInBox").style.display = "none";
  $("modalMsg").innerHTML = "";
});

// ‚úÖ LOGIN ACTION (Email OR Phone)
$("doLogin").addEventListener("click", async ()=>{
  const id = ($("loginId").value||"").trim();
  const pass = ($("loginPass").value||"").trim();
  if(!id || !pass){
    setModalMsg(false, "Email ya phone aur password required.");
    return;
  }
  setModalMsg(true, "Logging in...");
  const r = await doLogin(id, pass);
  setModalMsg(r.ok, r.msg);
  if(r.ok){
    renderAuthState();
    await speak("Theek hai Bhai jaan, login ho gaya.");
  }else{
    await speak("Maazrat Bhai jaan, login nahi ho saka.");
  }
});

$("logoutBtn").addEventListener("click", async ()=>{
  clearTokens();
  setModalMsg(true, "Logged out.");
  renderAuthState();
  await speak("Theek hai Bhai jaan, logout ho gaya.");
});

(function init(){
  hideSupport();
  setStatus("");
  const t = getTokens();
  $("authBtn").innerText = t.access ? "Account" : "Login";
})();
</script>
</body>
</html>
