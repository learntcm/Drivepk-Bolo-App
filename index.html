<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e6e6e6;}
  header{background:#000;color:#fff;padding:10px;display:flex;gap:10px;align-items:center;}
  .logo{background:#E81F25;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;}
  .main{padding:10px;max-width:520px;margin:0 auto;}
  .hero{background:#000;border-radius:18px;height:22vh;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:10px;}
  .hero h1{font-size:30px;margin:0;}
  .hero h2{font-size:14px;color:#E81F25;margin-top:4px;}
  input,button{width:100%;height:46px;border-radius:12px;font-size:15px;box-sizing:border-box;}
  input{padding:0 14px;border:1px solid #ccc;margin-bottom:6px;}
  button{border:none;background:#000;color:#fff;cursor:pointer;}
  .call{background:#E81F25;font-size:16px;margin-top:6px;user-select:none;transition:filter .08s ease,transform .08s ease;}
  .call.calling{background:#999;color:#000;}
  .call.talking{filter:brightness(0.78);transform:scale(0.985);}
  #hint{margin-top:6px;font-size:12px;color:#333;opacity:.85;}
  #status{margin-top:6px;font-weight:bold;color:#E81F25;font-size:14px;}
  #results{margin-top:10px;}
  .car{background:#fff;border-radius:12px;padding:8px;margin-bottom:10px;}
  .car img{width:100%;height:140px;object-fit:cover;border-radius:8px;}
  #supportBox{display:none;margin-top:10px;background:#fff;border-radius:12px;padding:10px;}
</style>
</head>
<body>
<header>
  <div class="logo">D</div>
  <div><strong>DrivePK</strong><br><small>Bolo aur gaari dhoondo</small></div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: MG Lahore 2022" />
  <button id="searchBtn">Search</button>

  <button class="call" id="callBtn">CALL</button>
  <div id="hint">Call dabayen. Phir mic ko press & hold karke bolen.</div>

  <div id="status"></div>

  <div id="supportBox">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px;font-size:18px;color:#E81F25;font-weight:bold;">051 8319037</div>
    <div style="margin-top:4px;font-size:12px;opacity:.8;">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<script>
const VOICE_API="https://meilibeauty.co.uk/voice.php";
const SEARCH_API="https://meilibeauty.co.uk/search.php";

const COMPANY_NUMBER="051 8319037";
const WEBSITE="www.drivepk.com";
const OFFICE_ADDRESS="195, Peshawar Road, Chur Chowk Beside PSO Pump, Westridge, Rawalpindi.";

const LADIES=["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const VOICE_BY_LADY={
  "Kiran":{voice:"marin",speed:0.95},
  "Reshma":{voice:"cedar",speed:0.95},
  "Mahnoor":{voice:"shimmer",speed:0.98},
  "Gul Noor":{voice:"coral",speed:0.95},
  "Dil Bahar":{voice:"nova",speed:0.98},
  "Shaheen":{voice:"sage",speed:0.95}
};

// Boss "Umar" voice (you can change later to onyx if you want male)
const BOSS_UMAR={voice:"coral",speed:0.95};

const RESULT_LINES=[
  "Jee, yeh aap ke search results hain.",
  "Acha jee, results aa gaye hain.",
  "Theek hai, matching gaariyan mil gayi hain.",
  "Yeh rahi aap ki search results."
];
const NO_RESULT_LINES=[
  "Is search par koi gaari available nahi.",
  "Maazrat, is waqt koi matching gaari nahi mili.",
  "Koi gaari nahi mili, aap model ya city change karke try karein."
];
const UNKNOWN_LINES=[
  "Sorry, abhi mujhe is ka jawab maloom nahi hai.",
  "Abhi main sirf gaari search mein help karti hoon. Aap car ka model, year aur city bol dein.",
  "Maazrat, is cheez mein help nahi ho pa rahi. Aap gaari ka brand aur city batayein."
];

const SILENCE_MS=5000, END_WAIT_MS=900, MIN_HOLD_MS=400;

let callConnected=false, recognition=null, isRecognizing=false, transcript="";
let silenceTimer=null, micReady=false, currentAudio=null, speakSeq=0;
let holding=false, holdStartTs=0, micFailCount=0;

function getProfile(){return JSON.parse(localStorage.getItem("boloProfile")||"{}");}
function saveProfile(p){localStorage.setItem("boloProfile",JSON.stringify(p));}
function rand(a){return a[Math.floor(Math.random()*a.length)];}
function randLady(){return LADIES[Math.floor(Math.random()*LADIES.length)];}
function setStatus(t){document.getElementById("status").innerText=t||"";}
function clearSilence(){if(silenceTimer){clearTimeout(silenceTimer);silenceTimer=null;}}
function showSupport(){document.getElementById("supportBox").style.display="block";}
function hideSupport(){document.getElementById("supportBox").style.display="none";}
function normalize(t){return (t||"").toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," ").trim();}

function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){p.lady=randLady();saveProfile(p);}
  return p.lady;
}

function isDoctorName(nm){
  const s=(nm||"").toLowerCase().trim();
  return s.startsWith("dr")||s.startsWith("doctor")||s.includes(" dr ")||s.includes("doctor ");
}
function respectfulName(p){
  if(!p||!p.name) return "bhai";
  const nm=(p.name||"").trim();
  if(isDoctorName(nm)) return "Dr sahib";
  return nm.split(" ")[0]+" bhai";
}

function extractName(text){
  const t=(text||"").trim();
  const m=t.match(/(my name is|mera naam)\s+(.+)/i);
  let raw=m?m[2]:t;
  raw=raw.replace(/[^a-zA-Z\s]/g," ").replace(/\s+/g," ").trim();
  if(!raw) return null;
  const parts=raw.split(" ").slice(0,3);
  return parts.map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
}

function stopAllVoice(){
  if(currentAudio){try{currentAudio.pause();currentAudio.currentTime=0;}catch(e){} currentAudio=null;}
}

function stopMic(){
  if(!recognition) return;
  try{recognition.onresult=null;recognition.onerror=null;recognition.onend=null;}catch(e){}
  try{recognition.abort();}catch(e){}
  try{recognition.stop();}catch(e){}
  isRecognizing=false; clearSilence();
}

async function warmupMic(){
  if(micReady) return true;
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    s.getTracks().forEach(t=>t.stop());
    micReady=true; return true;
  }catch{ return false; }
}

function getLadyVoicePack(){
  const p=getProfile();
  const lady=p.lady||getOrAssignLady();
  return VOICE_BY_LADY[lady]||{voice:"marin",speed:0.95};
}

async function speak(text, voicePack){
  const mySeq=++speakSeq;
  stopMic(); stopAllVoice(); clearSilence();
  setStatus(text);

  const vp=voicePack||getLadyVoicePack();
  // âœ… also round speed in frontend (extra safety)
  const safeSpeed = Number((vp.speed||0.95).toFixed(2));

  let res;
  try{
    res=await fetch(VOICE_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text, voice:vp.voice, speed:safeSpeed})
    });
  }catch{ return; }
  if(!res||!res.ok) return;

  const blob=await res.blob();
  if(mySeq!==speakSeq) return;

  const audio=new Audio(URL.createObjectURL(blob));
  currentAudio=audio;
  return new Promise(resolve=>{
    const done=()=>{ if(mySeq===speakSeq) currentAudio=null; resolve(); };
    audio.onended=done; audio.onerror=done;
    audio.play().catch(done);
  });
}

async function ring(){
  const times=Math.floor(Math.random()*3)+1;
  for(let i=0;i<times;i++){
    await new Promise(r=>{
      const a=new Audio("ringtone.mp4");
      a.onended=()=>setTimeout(r,350);
      a.play().catch(r);
    });
  }
}

if("webkitSpeechRecognition" in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="en-IN";
  recognition.interimResults=true;
  recognition.continuous=true;
}

function wantsBoss(t){
  t=normalize(t);
  return ["boss","manager","supervisor","owner","boss se baat","boss se milao","boss se baat karwao","mujhe boss se baat karni hai","umar","umar se baat"].some(x=>t.includes(x));
}
function wantsComplaint(t){
  t=normalize(t);
  return ["complaint","complain","shikayat","issue","problem","masla","support","customer care"].some(x=>t.includes(x));
}
function wantsNewLady(t){
  t=normalize(t);
  return ["change lady","switch lady","another lady","other lady","dusri madam","dusri lady","aur madam chahiye","koi aur lady","dusri madam se baat karwao","koi khoobsurat lady chahiye"].some(x=>t.includes(x));
}
function isAskingMyName(t){
  t=normalize(t);
  return t.includes("your name")||t.includes("aap ka naam")||t.includes("ap ka naam")||t.includes("naam kya");
}
function isAskingAddress(t){
  t=normalize(t);
  return t.includes("address")||t.includes("office")||t.includes("location")||t.includes("kidhar")||t.includes("kahan")||t.includes("pata");
}
function isAskingPhone(t){
  t=normalize(t);
  return t.includes("phone")||t.includes("number")||t.includes("contact")||t.includes("whatsapp");
}
function isAskingWebsite(t){
  t=normalize(t);
  return t.includes("website")||t.includes("site")||t.includes("url")||t.includes("link");
}

// car-search detector
const BRANDS=["toyota","honda","suzuki","kia","hyundai","mg","haval","changan","byd","nissan","bmw","audi","mercedes","proton","dfsk","baic","isuzu","jac","peugeot"];
const CITIES=["lahore","karachi","islamabad","rawalpindi","peshawar","multan","faisalabad","quetta","sialkot","gujranwala","abbottabad","mansehra","swat"];
function looksLikeCarSearch(t){
  const x=normalize(t);
  if(!x) return false;
  if(/\b(19|20)\d{2}\b/.test(x)) return true;
  if(x.includes("gaari")||x.includes("car")||x.includes("model")||x.includes("year")) return true;
  if(BRANDS.some(b=>x.includes(b))) return true;
  if(CITIES.some(c=>x.includes(c))) return true;
  return false;
}

async function startListening(){
  if(!callConnected||holding) return;
  holding=true; holdStartTs=Date.now();

  stopAllVoice(); hideSupport();

  if(!recognition){ holding=false; await speak("Mic supported nahi hai. Please type karke search karein."); return; }
  const ok=await warmupMic();
  if(!ok){ holding=false; await speak("Mic permission allow nahi. Please type kar dein."); return; }

  transcript=""; isRecognizing=true;
  const btn=document.getElementById("callBtn");
  btn.classList.add("talking"); btn.innerText="LISTENING...";
  setStatus("Sun rahi hoon...");

  clearSilence();
  silenceTimer=setTimeout(async ()=>{
    if(isRecognizing && !transcript){
      const p=getProfile();
      await speak(respectfulName(p)+", model, year aur city bol dein.");
    }
  }, SILENCE_MS);

  recognition.onresult=(e)=>{
    try{
      let last="";
      for(let i=0;i<e.results.length;i++){
        const r=e.results[i];
        if(r && r[0] && r[0].transcript) last=r[0].transcript;
      }
      if(last) transcript=last;
    }catch(err){}
  };
  recognition.onerror=()=>{isRecognizing=false;clearSilence();};
  recognition.onend=()=>{isRecognizing=false;clearSilence();};

  try{ recognition.start(); }catch(e){ holding=false; isRecognizing=false; clearSilence(); }
}

async function stopListening(){
  if(!holding) return;
  holding=false;

  const btn=document.getElementById("callBtn");
  btn.classList.remove("talking"); btn.innerText="HOLD TO TALK";

  if(!recognition || !isRecognizing) return;

  const heldMs=Date.now()-holdStartTs;
  if(heldMs<MIN_HOLD_MS) await new Promise(r=>setTimeout(r,MIN_HOLD_MS-heldMs));

  clearSilence();
  try{ recognition.stop(); }catch(e){}
  await new Promise(r=>setTimeout(r,END_WAIT_MS));

  const spoken=(transcript||"").trim();
  if(!spoken){
    micFailCount++;
    if(micFailCount===1) await speak("Awaaz clear nahi aayi. Button ko press karke hold rakhein, phir bol kar release karein.");
    else await speak("Lagta hai mic record nahi kar raha. Aap type karke bhi likh sakte hain.");
    return;
  }
  micFailCount=0;
  await handleSpoken(spoken);
}

async function handleSpoken(text){
  const p=getProfile();
  const who=respectfulName(p);

  if(!p.name){
    if(isAskingMyName(text)){
      const lady=p.lady||getOrAssignLady();
      await speak("Mera naam "+lady+" hai. Kia main aap ka naam pooch sakti hoon?");
      return;
    }
    const nm=extractName(text);
    if(!nm){ await speak("Naam clear nahi aaya. Sirf apna naam dobara bol dein."); return; }
    p.name=nm; saveProfile(p);
    await speak("Shukriya "+respectfulName(p)+". Ab apni requirement bol dein.");
    return;
  }

  // FAQ
  if(isAskingAddress(text)){ await speak(who+", hamara office address hai: "+OFFICE_ADDRESS); return; }
  if(isAskingPhone(text)){ showSupport(); await speak(who+", contact number hai: "+COMPANY_NUMBER+". WhatsApp bhi isi par hai."); return; }
  if(isAskingWebsite(text)){ await speak(who+", hamari website hai: "+WEBSITE); return; }

  // complaint
  if(wantsComplaint(text)){ showSupport(); await speak(who+", complaint ke liye please is number par call karein: "+COMPANY_NUMBER+"."); return; }
  hideSupport();

  // boss
  if(wantsBoss(text)){
    await speak(who+", theek hai. Main aap ko Umar se connect kar rahi hoon.");
    await ring();
    await speak(who+", Assalam o Alaikum. Main Umar hoon. Aap ka masla kya hai?", BOSS_UMAR);
    return;
  }

  // change lady
  if(wantsNewLady(text)){
    const cur=p.lady||getOrAssignLady();
    const others=LADIES.filter(x=>x!==cur);
    p.lady=rand(others.length?others:LADIES); saveProfile(p);
    const newLady=p.lady;
    await speak(who+", theek hai. Ab "+newLady+" baat karegi.");
    await speak("Assalam o Alaikum "+who+". Main "+newLady+" hoon.");
    return;
  }

  // name
  if(isAskingMyName(text)){
    const lady=p.lady||getOrAssignLady();
    await speak(who+", mera naam "+lady+" hai.");
    return;
  }

  // not a car query
  if(!looksLikeCarSearch(text)){
    await speak(rand(UNKNOWN_LINES));
    return;
  }

  document.getElementById("query").value=text;
  const count=await runSearch(text);
  if(count>0) await speak(rand(RESULT_LINES));
  else await speak(rand(NO_RESULT_LINES));
}

async function runSearch(text){
  const results=document.getElementById("results");
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hain...</p>";

  let res;
  try{
    res=await fetch(SEARCH_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text})
    });
  }catch{
    results.innerHTML="<p>Search error</p>";
    return 0;
  }

  let json=null;
  try{ json=await res.json(); }catch(e){}

  results.innerHTML="";
  if(!json||!json.data||!json.data.length){
    results.innerHTML="<p>No cars available</p>";
    return 0;
  }

  json.data.forEach(c=>{
    const img=(c.images&&c.images[0])?c.images[0]:"";
    const price=c.price?Number(c.price).toLocaleString():"Call";
    const title=c.title||"-";
    const year=c.year||"-";
    const city=(c.location&&c.location.city)?c.location.city:"-";
    results.innerHTML+=
      `<div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${title}</h3>
        <div>${year} - ${city}</div>
        <strong>PKR ${price}</strong>
      </div>`;
  });

  return json.data.length;
}

async function connectCall(){
  stopAllVoice(); stopMic(); hideSupport();

  const btn=document.getElementById("callBtn");
  btn.classList.add("calling"); btn.innerText="CALLING..."; btn.disabled=true;

  await ring();

  callConnected=true;
  btn.classList.remove("calling");
  btn.disabled=false;
  btn.innerText="HOLD TO TALK";
  document.getElementById("hint").innerText="Press & hold and speak.";

  const p=getProfile();
  const lady=getOrAssignLady();

  if(!p.name){
    await speak("Assalam o Alaikum! DrivePK mein khush aamadid. Mera naam "+lady+" hai. Kia main aap ka naam pooch sakti hoon?");
  }else{
    await speak(respectfulName(p)+", Assalam o Alaikum. Model, year aur city bol dein.");
  }
  await warmupMic();
}

document.getElementById("callBtn").addEventListener("click", async ()=>{
  if(!callConnected) await connectCall();
});

document.getElementById("callBtn").addEventListener("pointerdown", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  try{ e.target.setPointerCapture(e.pointerId); }catch(err){}
  startListening();
});
document.getElementById("callBtn").addEventListener("pointerup", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});
document.getElementById("callBtn").addEventListener("pointercancel", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

document.getElementById("searchBtn").addEventListener("click", async ()=>{
  const t=(document.getElementById("query").value||"").trim();
  if(!t) return;
  if(!looksLikeCarSearch(t)){ await speak(rand(UNKNOWN_LINES)); return; }
  const count=await runSearch(t);
  if(count>0) await speak(rand(RESULT_LINES));
  else await speak(rand(NO_RESULT_LINES));
});
</script>
</body>
</html>