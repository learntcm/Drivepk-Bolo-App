<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#e6e6e6; }
header{ background:#000; color:#fff; padding:10px; display:flex; gap:10px; align-items:center; }
.logo{ background:#E81F25; width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:bold; }
.main{ padding:10px; }
.hero{ background:#000; border-radius:18px; height:22vh; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:10px; }
.hero h1{ font-size:30px; margin:0; }
.hero h2{ font-size:14px; color:#E81F25; margin-top:4px; }

input,button{ width:100%; height:46px; border-radius:12px; font-size:15px; }
input{ padding:0 14px; border:1px solid #ccc; margin-bottom:6px; }
button{ border:none; background:#000; color:#fff; cursor:pointer; }

.call{ background:#E81F25; font-size:16px; margin-top:6px; transition:transform .05s ease, filter .05s ease; }
.call.calling{ background:#999; color:#000; }
.call.talking{ filter:brightness(0.75); transform:scale(0.985); }

#status{ margin-top:6px; font-weight:bold; color:#E81F25; font-size:14px; }
#results{ margin-top:10px; }
.car{ background:#fff; border-radius:12px; padding:8px; margin-bottom:10px; }
.car img{ width:100%; height:140px; object-fit:cover; border-radius:8px; }
.smallHint{ margin-top:6px; font-size:12px; color:#333; opacity:0.85; }
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Pakistani Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>

  <button class="call" id="callBtn">ðŸ“ž CALL</button>
  <div class="smallHint" id="hint">Call dabayen. Phir ðŸŽ¤ ko press & hold karke bolen.</div>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];

const HOLD_HINT = "ðŸŽ¤ Press & hold karke bolen. Chhorne par sunna band ho jayega.";
const MIC_FAIL_MAX = 2;
const SILENCE_MS = 5000;              // âœ… reminder after 5 seconds
const BETWEEN_PROMPTS_MS = 5000;      // âœ… 2nd/3rd prompt delay 5 seconds
const POST_TTS_GAP_MS = 250;

/* =========================
   STATE
========================= */
let callConnected = false;
let currentAudio = null;
let speaking = false;

let recognition = null;
let listening = false;
let isRecognizing = false;
let micFailCount = 0;
let silenceTimer = null;

let transcriptBuffer = "";
let stopResolver = null;

let micWarmed = false;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){ p.lady = rand(LADIES); saveProfile(p); }
  return p.lady;
}

/* =========================
   UTIL
========================= */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function clearSilenceTimer(){ if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; } }
function setStatus(t){ status.innerText = t; }

/* =========================
   MIC WARM-UP (CRITICAL FIX)
   Some Android phones won't record SpeechRecognition unless getUserMedia
   is granted in the same session.
========================= */
async function warmupMic(){
  if(micWarmed) return true;
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return true;

  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    // stop immediately
    stream.getTracks().forEach(t => t.stop());
    micWarmed = true;
    return true;
  }catch(e){
    // user blocked mic at browser level
    return false;
  }
}

/* =========================
   AUDIO (TTS)
========================= */
function stopAudio(){
  if(currentAudio){
    try { currentAudio.pause(); currentAudio.currentTime=0; } catch(e){}
    currentAudio=null;
  }
}

function hardStopMic(){
  if(!recognition) return;
  try { recognition.onresult=null; recognition.onerror=null; recognition.onend=null; } catch(e){}
  try { recognition.abort(); } catch(e){}
  try { recognition.stop(); } catch(e){}
  listening = false;
  isRecognizing = false;
  clearSilenceTimer();
  if(stopResolver){ stopResolver(); stopResolver=null; }
}

async function speak(text){
  hardStopMic();
  stopAudio();
  clearSilenceTimer();

  speaking = true;
  setStatus(text);

  const res = await fetch(VOICE_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  const blob = await res.blob();
  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    audio.onended = () => { currentAudio=null; speaking=false; setTimeout(resolve, POST_TTS_GAP_MS); };
    audio.onerror = () => { currentAudio=null; speaking=false; resolve(); };
    audio.play().catch(() => { currentAudio=null; speaking=false; resolve(); });
  });
}

/* =========================
   RING
========================= */
async function ringPhone(){
  const rings = Math.floor(Math.random()*3)+1;
  for(let i=0;i<rings;i++){
    await new Promise(res=>{
      const r = new Audio("ringtone.mp4");
      r.onended = () => setTimeout(res, 450);
      r.play().catch(res);
    });
  }
}

/* =========================
   SPEECH RECOGNITION
========================= */
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-GB";
  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;
}

async function startHoldListening(){
  if(!recognition){
    micFailCount++;
    await speak(typingFallbackLine());
    return;
  }
  if(speaking) return;
  if(isRecognizing) return; // guard

  const ok = await warmupMic();
  if(!ok){
    micFailCount++;
    await speak("Mic permission allow nahi hai. Behtar hai aap type kar dein.");
    return;
  }

  // UI feedback
  callBtn.classList.add("talking");
  callBtn.innerText = "ðŸŽ™ LISTENINGâ€¦";
  setStatus("Sun rahi hoonâ€¦ " + HOLD_HINT);

  transcriptBuffer = "";
  listening = true;
  isRecognizing = true;

  clearSilenceTimer();
  silenceTimer = setTimeout(async ()=>{
    if(listening && !transcriptBuffer){
      const p=getProfile();
      const nm = p.name || "Doctor";
      await speak(`${nm} bhai, mujhe awaaz clear nahi aa rahi. Model, year aur city bol dein.`);
      setStatus(HOLD_HINT);
    }
  }, SILENCE_MS);

  recognition.onresult = e => {
    transcriptBuffer = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript)
      ? e.results[0][0].transcript
      : "";
  };

  recognition.onerror = () => {
    micFailCount++;
  };

  recognition.onend = () => {
    listening = false;
    isRecognizing = false;
    clearSilenceTimer();
    if(stopResolver){ stopResolver(); stopResolver=null; }
  };

  try {
    recognition.start();
  } catch(e) {
    micFailCount++;
    listening = false;
    isRecognizing = false;
    clearSilenceTimer();
  }
}

async function stopHoldListeningAndHandle(){
  if(!recognition) return;

  // restore UI even if weird state
  callBtn.classList.remove("talking");
  callBtn.innerText = "ðŸŽ¤ HOLD TO TALK";

  if(!isRecognizing){
    return;
  }

  clearSilenceTimer();
  try { recognition.stop(); } catch(e) {}

  // wait for onend OR timeout so transcript can arrive
  await new Promise(resolve=>{
    stopResolver = resolve;
    setTimeout(resolve, 1500);
  });
  stopResolver = null;

  const spoken = (transcriptBuffer || "").trim();

  if(!spoken){
    micFailCount++;
    if(micFailCount >= MIC_FAIL_MAX){
      await speak(typingFallbackLine());
      setStatus("Mic issue ho sakta hai. Type karke Search karein.");
    } else {
      setStatus("Kuch sunai nahi diya. " + HOLD_HINT);
    }
    return;
  }

  micFailCount = 0;

  // Name flow
  const needName = await maybeSaveNameFromSpoken(spoken);
  if(needName) return;

  // Normal search
  query.value = spoken;
  const p=getProfile();
  p.lastSearch = spoken;
  saveProfile(p);
  await runSearch(spoken);
  setStatus("Results aa gaye. Dobara bolna ho to " + HOLD_HINT);
}

/* =========================
   MESSAGES
========================= */
function welcomeReturning(name){
  return rand([
    `${name} bhai, Assalam o Alaikum. Kya madad karun?`,
    `${name} bhai, salam. Aaj kya dhoondhna hai?`,
    `${name} bhai, welcome back. Bata dein konsi gaari chahiye?`
  ]);
}
function welcomeFirst(lady){
  return rand([
    `Assalam o Alaikum! DrivePK mein khush aamadid. Main ${lady} hoon.`,
    `Salam! DrivePK se baat ho rahi hai. Main ${lady} hoon.`,
    `Assalam o Alaikum! DrivePK ki taraf se. Main ${lady} hoon.`
  ]);
}
function askNameLine(){
  return rand([
    "Doctor bhai, aap ka naam kya hai?",
    "Doctor bhai, main aap ka naam jaan sakti hoon?",
    "Doctor bhai, aap apna naam bata dein please."
  ]);
}
function askRequirementLine(name){
  return rand([
    `${name} bhai, apni requirement bol dein â€” jaise model, year aur city.`,
    `${name} bhai, model aur city bata dein please.`,
    `${name} bhai, konsi gaari chahiye? Model/year/city bol dein.`
  ]);
}
function typingFallbackLine(){
  return rand([
    "Mujhe aap ki awaaz clear nahi aa rahi. Behtar hai aap type kar dein.",
    "Mic issue lag raha hai. Aap please type karke search kar lein.",
    "Awaaz receive nahi ho rahi. Kindly text box mein likh dein."
  ]);
}

/* =========================
   NAME HANDLING
========================= */
function tidyName(raw){
  return raw.replace(/[^a-zA-Z\s]/g," ").replace(/\s+/g," ").trim().split(" ").slice(0,3)
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
}
function extractName(text){
  const t=(text||"").trim();
  let m = t.match(/(my name is|mera naam)\s+(.+)/i);
  if(m) return tidyName(m[2]);
  const cleaned = tidyName(t);
  if(cleaned && cleaned.length >= 2) return cleaned;
  return null;
}
async function maybeSaveNameFromSpoken(spoken){
  const p=getProfile();
  if(p.name) return false;

  const name = extractName(spoken);
  if(!name){
    await speak("Naam clear nahi aaya. Sirf apna naam dobara bol dein.");
    setStatus(HOLD_HINT);
    return true;
  }

  p.name = name;
  saveProfile(p);

  await speak(`Shukriya ${name} bhai.`);
  await sleep(BETWEEN_PROMPTS_MS);          // âœ… 5s delay
  await speak(askRequirementLine(name));
  setStatus(HOLD_HINT);
  return true;
}

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch(SEARCH_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  let json=null;
  try{ json=await res.json(); }catch(e){}
  results.innerHTML="";

  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }

  json.data.forEach(c=>{
    const img=c.images?.[0]||"";
    const price=c.price?Number(c.price).toLocaleString():"Call";
    results.innerHTML += `
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title||"-"}</h3>
        <div>${c.year||"-"} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });
}

/* =========================
   CALL FLOW
========================= */
async function connectCall(){
  callBtn.classList.add("calling");
  callBtn.innerText="ðŸ“ž CALLINGâ€¦";
  callBtn.disabled=true;

  hardStopMic(); stopAudio(); clearSilenceTimer();

  await ringPhone();

  callConnected = true;
  callBtn.classList.remove("calling");
  callBtn.disabled=false;
  callBtn.innerText="ðŸŽ¤ HOLD TO TALK";
  hint.innerText = HOLD_HINT;

  // warm up mic once after user gesture (very effective)
  await warmupMic();

  const p=getProfile();
  const lady=getOrAssignLady();

  if(!p.name){
    await speak(welcomeFirst(lady));
    await sleep(BETWEEN_PROMPTS_MS);        // âœ… 5s delay
    await speak(askNameLine());
    setStatus("Apna naam bolne ke liye " + HOLD_HINT);
  } else {
    await speak(welcomeReturning(p.name));
    await sleep(BETWEEN_PROMPTS_MS);        // âœ… 5s delay
    await speak(askRequirementLine(p.name));
    setStatus(HOLD_HINT);
  }
}

/* =========================
   BUTTON WIRING
========================= */
callBtn.addEventListener("click", async () => {
  if(!callConnected){
    await connectCall();
  }
});

function bindHoldEvents(btn){
  btn.addEventListener("touchstart", (e)=>{
    if(!callConnected) return;
    e.preventDefault();
    startHoldListening();
  }, {passive:false});

  btn.addEventListener("touchend", async (e)=>{
    if(!callConnected) return;
    e.preventDefault();
    await stopHoldListeningAndHandle();
  }, {passive:false});

  btn.addEventListener("mousedown", ()=>{
    if(!callConnected) return;
    startHoldListening();
  });
  btn.addEventListener("mouseup", async ()=>{
    if(!callConnected) return;
    await stopHoldListeningAndHandle();
  });
  btn.addEventListener("mouseleave", async ()=>{
    if(!callConnected) return;
    await stopHoldListeningAndHandle();
  });
}
bindHoldEvents(callBtn);

/* Manual Search */
searchBtn.onclick = async () => {
  const t=query.value.trim();
  if(!t) return;
  const p=getProfile();
  p.lastSearch=t;
  saveProfile(p);
  await runSearch(t);
};
</script>
</body>
</html>
