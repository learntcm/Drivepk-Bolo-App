<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>

<style>
  :root{
    --red:#E81F25;
    --black:#000;
    --bg:#e6e6e6;
    --card:#ffffff;
    --muted:#7a7a7a;
  }
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);}

  header{
    background:var(--black);
    color:#fff;
    padding:10px 12px;
    display:flex;gap:10px;align-items:center;
  }
  .logo{
    background:var(--red);
    width:38px;height:38px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    font-size:16px;font-weight:bold;
  }
  .brand{font-weight:800; letter-spacing:.3px;}

  .main{padding:10px;max-width:520px;margin:0 auto;}

  /* HERO BANNER (same concept you had before) */
  .hero{
    background:#000;
    border-radius:18px;
    height:22vh;min-height:140px;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    color:#fff;
    margin-bottom:10px;
    position:relative;
    overflow:hidden;
  }
  .hero::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 20% 20%, rgba(232,31,37,.35), transparent 45%),
      radial-gradient(circle at 80% 70%, rgba(232,31,37,.25), transparent 50%);
    pointer-events:none;
  }
  .hero h1{margin:0;font-size:22px;z-index:1;}
  .hero p{margin:6px 0 0;color:#cfcfcf;font-size:13px;z-index:1;}
  .hero .tag{
    margin-top:10px;
    background:var(--red);
    padding:8px 12px;
    border-radius:14px;
    font-weight:800;
    font-size:13px;
    z-index:1;
  }

  /* SEARCH BAR */
  .bar{display:flex;gap:10px;align-items:center;margin-bottom:10px;}
  input{
    flex:1;
    border:none;
    border-radius:14px;
    padding:12px 12px;
    outline:none;
    background:#111;
    color:#fff;
    box-shadow:0 2px 10px rgba(0,0,0,.12) inset;
  }
  button{
    border:none;
    padding:12px 14px;
    border-radius:14px;
    font-weight:800;
    cursor:pointer;
  }
  .btnSearch{background:var(--red);color:#fff;}
  .btnClear{background:#4a4a4a;color:#fff;}

  /* STATUS */
  .status{font-size:13px;color:#333;margin:8px 2px;}
  .err{color:#b00020;font-weight:800;}

  /* RESULTS */
  .card{
    background:var(--card);
    border-radius:18px;
    padding:12px;
    margin:10px 0;
    box-shadow:0 10px 25px rgba(0,0,0,.08);
  }
  .title{margin:0 0 6px;font-size:16px;font-weight:900;}
  .meta{margin:0;color:var(--muted);font-size:13px;line-height:1.35;}
  .row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;}
  .price{background:#000;color:#fff;padding:8px 10px;border-radius:12px;font-weight:900;}
  .pill{background:#f2f2f2;color:#111;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;}
  .thumb{
    width:100%;
    height:180px;
    object-fit:cover;
    border-radius:14px;
    background:#ddd;
    display:block;
    margin-bottom:10px;
  }

  /* Voice button */
  .voiceRow{display:flex;gap:10px;margin-top:8px;margin-bottom:4px;}
  .btnVoice{background:#000;color:#fff;flex:1;}
</style>
</head>

<body>
<header>
  <div class="logo">DP</div>
  <div class="brand">DrivePK BOLO</div>
</header>

<div class="main">

  <div class="hero">
    <h1>Find Cars Fast</h1>
    <p>Speak or type: ‚ÄúHonda in Karachi‚Äù</p>
    <div class="tag">AI Search (Beta)</div>
  </div>

  <div class="bar">
    <input id="q" placeholder="Search: Toyota Corolla 2020 Lahore" />
    <button class="btnSearch" id="searchBtn">Search</button>
    <button class="btnClear" id="clearBtn">Clear</button>
  </div>

  <div class="voiceRow">
    <button class="btnVoice" id="voiceBtn">üé§ Voice Search</button>
  </div>

  <div class="status" id="status"></div>

  <div id="results"></div>

</div>

<script>
  // IMPORTANT:
  // This file calls YOUR OWN SERVER proxy endpoint:
  // /api/cars -> server.js will fetch https://api.drivepk.com/cars for you.
  const API_PROXY = "/api/cars";

  const qEl = document.getElementById("q");
  const statusEl = document.getElementById("status");
  const resultsEl = document.getElementById("results");

  function setStatus(msg, isErr=false){
    statusEl.textContent = msg || "";
    statusEl.className = "status" + (isErr ? " err" : "");
  }

  function formatPKR(v){
    const n = Number(v || 0);
    return "PKR " + n.toLocaleString("en-PK");
  }

  // Parse "Honda in Karachi" into brand + city
  const BRANDS = ["honda","toyota","suzuki","kia","hyundai","mg","changan","nissan","mitsubishi","audi","bmw","mercedes"];
  const CITIES = ["karachi","lahore","islamabad","rawalpindi","peshawar","quetta","faisalabad","multan","hyderabad","gujranwala"];

  function parseQuery(text){
    const t = (text || "").toLowerCase();
    const brand = BRANDS.find(b => t.includes(b)) || "";
    const city = CITIES.find(c => t.includes(c)) || "";

    // year
    const yearMatch = t.match(/\b(19\d{2}|20\d{2})\b/);
    const year = yearMatch ? yearMatch[1] : "";

    // model guess (simple)
    let model = "";
    if (brand){
      const after = t.split(brand)[1] || "";
      const words = after.split(/\s+/).filter(Boolean);
      const cleaned = words.filter(w => w !== "in" && w !== city && !/^\d{4}$/.test(w));
      if (cleaned.length) model = cleaned[0];
    }

    const cap = s => s ? s.charAt(0).toUpperCase() + s.slice(1) : "";
    return { brand: cap(brand), city: cap(city), year, model: cap(model) };
  }

  function renderCars(cars){
    resultsEl.innerHTML = "";

    if (!cars || cars.length === 0){
      resultsEl.innerHTML = `
        <div class="card">
          <p class="title">No cars found</p>
          <p class="meta">Try a different brand/city or remove filters.</p>
        </div>
      `;
      return;
    }

    cars.forEach(car => {
      const img = car.images && car.images[0] ? car.images[0] : "";
      const brandName = car.brand && car.brand.name ? car.brand.name : "";
      const modelName = car.carModel && car.carModel.name ? car.carModel.name : "";
      const city = car.location && car.location.city ? car.location.city : "";
      const area = car.location && car.location.area ? car.location.area : "";
      const condition = car.condition || "active";

      resultsEl.insertAdjacentHTML("beforeend", `
        <div class="card">
          ${img ? `<img class="thumb" src="${img}" alt="car" onerror="this.style.display='none'">` : ""}
          <p class="title">${car.title || "Car"}</p>
          <p class="meta">
            ${brandName}${modelName ? " ‚Ä¢ " + modelName : ""}${car.year ? " ‚Ä¢ " + car.year : ""}<br>
            ${city}${area ? " ‚Ä¢ " + area : ""}
          </p>
          <div class="row">
            <div class="price">${formatPKR(car.price)}</div>
            <div class="pill">${condition}</div>
          </div>
        </div>
      `);
    });
  }

  async function searchCars(){
    const text = qEl.value.trim();
    if (!text){
      setStatus("Type something like: Honda in Karachi", true);
      return;
    }

    setStatus("Loading...");
    resultsEl.innerHTML = "";

    const { brand, city, year, model } = parseQuery(text);

    // Build query to proxy
    const url = new URL(window.location.origin + API_PROXY);
    if (brand) url.searchParams.set("brand", brand);
    if (city) url.searchParams.set("city", city);
    if (year) url.searchParams.set("year", year);
    if (model) url.searchParams.set("model", model);
    url.searchParams.set("limit", "20");
    url.searchParams.set("page", "1");

    try{
      const res = await fetch(url.toString(), { headers: { "Accept":"application/json" } });
      const json = await res.json();

      if (!res.ok) throw new Error(json.message || "API error");

      const cars = Array.isArray(json.data) ? json.data : [];
      setStatus("");
      renderCars(cars);
    } catch(err){
      setStatus("Error: " + (err.message || "Failed to fetch"), true);
      renderCars([]);
    }
  }

  document.getElementById("searchBtn").addEventListener("click", searchCars);
  document.getElementById("clearBtn").addEventListener("click", () => {
    qEl.value = "";
    setStatus("");
    resultsEl.innerHTML = "";
  });
  qEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") searchCars();
  });

  // Voice search
  const VoiceRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const voiceBtn = document.getElementById("voiceBtn");

  if (!VoiceRecognition){
    voiceBtn.textContent = "üé§ Voice Not Supported";
    voiceBtn.disabled = true;
  } else {
    const rec = new VoiceRecognition();
    rec.lang = "en-US";
    rec.interimResults = false;

    voiceBtn.addEventListener("click", () => {
      setStatus("Listening...");
      rec.start();
    });

    rec.onresult = (event) => {
      const text = event.results[0][0].transcript || "";
      qEl.value = text;
      searchCars();
    };

    rec.onerror = (e) => setStatus("Voice error: " + (e.error || "unknown"), true);
  }
</script>
</body>
</html>