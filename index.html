<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK Bolo App</title>

<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e6e6e6;}
  header{background:#000;color:#fff;padding:10px;display:flex;gap:10px;align-items:center;}
  .logo{background:#E81F25;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;}
  .main{padding:10px;max-width:520px;margin:0 auto;}
  .hero{background:#000;border-radius:18px;height:22vh;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:10px;}
  .hero h1{font-size:30px;margin:0;}
  .hero h2{font-size:14px;color:#E81F25;margin-top:4px;}

  input,button{width:100%;height:46px;border-radius:12px;font-size:15px;box-sizing:border-box;}
  input{padding:0 14px;border:1px solid #ccc;margin-bottom:6px;}
  button{border:none;background:#000;color:#fff;cursor:pointer;}

  .call{background:#E81F25;font-size:16px;margin-top:6px;user-select:none;transition:transform .06s ease, filter .06s ease;}
  .call.calling{background:#999;color:#000;}
  .call.talking{filter:brightness(.78);transform:scale(.985);}

  #status{margin-top:6px;font-weight:bold;color:#E81F25;font-size:14px;}
  #hint{margin-top:6px;font-size:12px;color:#333;opacity:.9;}
  #results{margin-top:10px;}
  .car{background:#fff;border-radius:12px;padding:8px;margin-bottom:10px;}
  .car img{width:100%;height:140px;object-fit:cover;border-radius:8px;}

  #supportBox{display:none;margin-top:10px;background:#fff;border-radius:12px;padding:10px;}
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Roman Urdu Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Vitz 2017 Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="hint">Call dabayen. Phir ðŸŽ¤ button ko press & hold karke bolen.</div>
  <div id="status"></div>

  <div id="supportBox">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px;font-size:18px;color:#E81F25;font-weight:bold;">051 8319037</div>
    <div style="margin-top:4px;font-size:12px;opacity:.8;">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<script>
/* =========================
   ENDPOINTS
========================= */
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const COMPANY_NUMBER = "051 8319037";

/* =========================
   ASSISTANT SETTINGS
========================= */
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const HOLD_HINT = "ðŸŽ¤ Press & hold karke bolen. Chhorne par sunna band ho jayega.";
const FOLLOWUP_DELAY_MS = 5000;     // follow-up prompt delay if user says nothing
const END_WAIT_MS = 650;            // wait after recognition.stop()
const DUPLICATE_WINDOW_MS = 2500;   // ignore same transcript repeating within this window

/* =========================
   STATE
========================= */
let callConnected = false;
let speaking = false;
let holding = false;

let recognition = null;
let isRecognizing = false;
let transcript = "";
let followupTimer = null;

let currentAudio = null;
let lastHeardText = "";
let lastHeardAt = 0;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){
    p.lady = rand(LADIES);
    saveProfile(p);
  }
  return p.lady;
}

/* =========================
   UI
========================= */
function setStatus(t){ status.innerText = t || ""; }
function showSupport(){ supportBox.style.display="block"; }
function hideSupport(){ supportBox.style.display="none"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function clearFollowup(){ if(followupTimer){ clearTimeout(followupTimer); followupTimer=null; } }

/* =========================
   STOP EVERYTHING (prevents double/tiple voice)
========================= */
function stopAllAudio(){
  if(currentAudio){
    try{ currentAudio.pause(); currentAudio.currentTime=0; }catch(e){}
    currentAudio=null;
  }
  try{
    if(window.speechSynthesis) window.speechSynthesis.cancel(); // defensive (old versions)
  }catch(e){}
}

function stopMicHard(){
  if(!recognition) return;
  try{ recognition.onresult=null; recognition.onerror=null; recognition.onend=null; }catch(e){}
  try{ recognition.abort(); }catch(e){}
  try{ recognition.stop(); }catch(e){}
  isRecognizing=false;
  clearFollowup();
}

/* =========================
   PAID TTS ONLY (voice.php)
   - mic OFF while speaking
========================= */
async function speak(text){
  stopMicHard();
  stopAllAudio();
  clearFollowup();

  speaking = true;
  setStatus(text);

  let res;
  try{
    res = await fetch(VOICE_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ text })
    });
  }catch(e){
    speaking=false;
    return;
  }

  if(!res.ok){
    speaking=false;
    return;
  }

  const blob = await res.blob();
  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    const done=()=>{ currentAudio=null; speaking=false; resolve(); };
    audio.onended=done;
    audio.onerror=done;
    audio.play().catch(done);
  });
}

/* =========================
   RING 1â€“3 times
========================= */
async function ringPhone(){
  const times = Math.floor(Math.random()*3)+1;
  for(let i=0;i<times;i++){
    await new Promise(r=>{
      const a = new Audio("ringtone.mp4");
      a.onended = ()=>setTimeout(r,350);
      a.play().catch(r);
    });
  }
}

/* =========================
   STT SETUP
========================= */
if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang="en-IN";
  recognition.interimResults=false;
  recognition.continuous=false;
  recognition.maxAlternatives=1;
}

/* =========================
   INTENTS
========================= */
function norm(t){ return (t||"").toLowerCase().trim(); }

function wantsBoss(t){
  t=norm(t);
  return t.includes("boss") || t.includes("umar") || t.includes("manager") || t.includes("supervisor");
}

function wantsComplaint(t){
  t=norm(t);
  return t.includes("complaint") || t.includes("complain") || t.includes("shikayat") || t.includes("support number") || t.includes("phone number");
}

function wantsNewLady(t){
  t=norm(t);
  return t.includes("change lady") || t.includes("dusri madam") || t.includes("dusri lady") ||
         t.includes("aur madam") || t.includes("khoobsurat lady") || t.includes("dusri madam se baat");
}

function isAskingAssistantName(t){
  t=norm(t);
  return t.includes("tumhara naam") || t.includes("aap ka naam") || t.includes("ap ka naam") || t.includes("what is your name");
}

function extractName(spoken){
  // accepts: "my name is Abdullah", "mera naam Abdullah", or just "Abdullah"
  const s = spoken.trim();
  let m = s.match(/(my name is|mera naam)\s+(.+)/i);
  let name = m ? m[2] : s;
  name = name.replace(/[^a-zA-Z\s]/g," ").replace(/\s+/g," ").trim();
  name = name.split(" ").slice(0,3).map(w => w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
  return name || null;
}

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";

  let res;
  try{
    res = await fetch(SEARCH_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ text })
    });
  }catch(e){
    results.innerHTML="<p>Search error</p>";
    return;
  }

  let json=null;
  try{ json=await res.json(); }catch(e){}

  results.innerHTML="";
  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }

  json.data.forEach(c=>{
    const img=c.images?.[0]||"";
    const price=c.price ? Number(c.price).toLocaleString() : "Call";
    results.innerHTML += `
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title||"-"}</h3>
        <div>${c.year||"-"} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${price}</strong>
      </div>`;
  });
}

/* =========================
   HOLD-TO-TALK (no auto listening)
   Fixes:
   - no premature prompts
   - no repeated transcript handling
========================= */
async function startListening(e){
  if(!callConnected) return;
  if(speaking) return;         // never listen while she speaks
  if(holding) return;          // prevent double start
  holding = true;

  stopAllAudio();
  hideSupport();
  clearFollowup();

  if(!recognition){
    holding=false;
    await speak("Is device par mic supported nahi. Please type karke search karein.");
    return;
  }

  transcript="";
  isRecognizing=true;

  callBtn.classList.add("talking");
  callBtn.innerText="ðŸŽ™ LISTENINGâ€¦";
  setStatus("Sun rahi hoonâ€¦ (hold rakhein)");

  recognition.onresult = (ev)=>{
    transcript = ev?.results?.[0]?.[0]?.transcript || "";
  };

  recognition.onend = ()=>{
    isRecognizing=false;
  };

  try{ recognition.start(); }catch(err){
    holding=false;
    isRecognizing=false;
  }

  // follow-up ONLY if user says nothing and keeps holding (rare), we do it on release instead
}

async function stopListening(){
  if(!holding) return;
  holding=false;

  callBtn.classList.remove("talking");
  callBtn.innerText="ðŸŽ¤ HOLD TO TALK";

  if(!recognition || !isRecognizing){
    return;
  }

  try{ recognition.stop(); }catch(e){}
  await sleep(END_WAIT_MS);

  const spoken = (transcript||"").trim();
  if(!spoken){
    // follow-up prompt delayed ONLY when nothing was said
    clearFollowup();
    followupTimer = setTimeout(async ()=>{
      const p=getProfile();
      const nm = p.name || "Doctor";
      await speak(`${nm} bhai, main sun nahi pa rahi. Model, year aur city bol dein, ya type kar dein.`);
      setStatus(HOLD_HINT);
    }, FOLLOWUP_DELAY_MS);
    return;
  }

  // ANTI-DUPLICATE: ignore repeating same text quickly
  const now = Date.now();
  const key = norm(spoken);
  if(key && key === lastHeardText && (now - lastHeardAt) < DUPLICATE_WINDOW_MS){
    return;
  }
  lastHeardText = key;
  lastHeardAt = now;

  await handleSpoken(spoken);
}

/* =========================
   SPOKEN ROUTER
========================= */
async function handleSpoken(spoken){
  clearFollowup();
  hideSupport();

  const p = getProfile();
  const lady = getOrAssignLady();
  const userName = p.name || "";

  // If name not saved yet -> save name flow
  if(!p.name){
    // If they ask your name first
    if(isAskingAssistantName(spoken)){
      await speak(`Mera naam ${lady} hai. Pehle aap apna naam bata dein, phir main gaari dhoond deti hoon.`);
      setStatus(HOLD_HINT);
      return;
    }

    const nm = extractName(spoken);
    if(!nm){
      await speak("Naam clear nahi aaya. Please sirf apna naam dobara bol dein.");
      setStatus(HOLD_HINT);
      return;
    }

    p.name = nm;
    saveProfile(p);

    await speak(`Shukriya ${nm} bhai.`);
    // IMPORTANT: do NOT immediately speak again; we wait for user
    await speak(`Ab aap konsi gaari chahte hain? Model, year aur city bol dein.`);
    setStatus(HOLD_HINT);
    return;
  }

  // Complaint
  if(wantsComplaint(spoken)){
    showSupport();
    await speak(`${p.name} bhai, complaint ke liye please is number par call karein: ${COMPANY_NUMBER}.`);
    setStatus("Complaints number screen par show ho gaya hai.");
    return;
  }

  // Boss
  if(wantsBoss(spoken)){
    await speak(`${p.name} bhai, main Umar hoon, DrivePK ka boss. Bataiye, kya masla hai?`);
    setStatus(HOLD_HINT);
    return;
  }

  // Change lady
  if(wantsNewLady(spoken)){
    const others = LADIES.filter(x=>x!==lady);
    p.lady = rand(others.length ? others : LADIES);
    saveProfile(p);
    await speak(`${p.name} bhai, theek hai. Ab ${p.lady} baat karegi.`);
    setStatus(HOLD_HINT);
    return;
  }

  // Ask assistant name
  if(isAskingAssistantName(spoken)){
    await speak(`${p.name} bhai, mera naam ${p.lady} hai.`);
    setStatus(HOLD_HINT);
    return;
  }

  // Otherwise: treat as search
  query.value = spoken;
  await runSearch(spoken);
  await speak(`${p.name} bhai, yeh rahi aap ki search results.`);
  setStatus(HOLD_HINT);
}

/* =========================
   CALL FLOW
========================= */
async function connectCall(){
  stopAllAudio();
  stopMicHard();
  clearFollowup();
  hideSupport();

  callBtn.classList.add("calling");
  callBtn.innerText="ðŸ“ž CALLINGâ€¦";
  callBtn.disabled=true;

  await ringPhone();

  callConnected=true;
  callBtn.classList.remove("calling");
  callBtn.disabled=false;
  callBtn.innerText="ðŸŽ¤ HOLD TO TALK";
  hint.innerText = "ðŸŽ¤ Press & hold karke bolen.";

  // Greeting (only once)
  const p=getProfile();
  const lady=getOrAssignLady();

  if(!p.name){
    await speak(`Assalam o Alaikum, DrivePK mein khush aamadid. Main ${lady} hoon. Doctor bhai, aap ka naam kya hai?`);
  }else{
    await speak(`${p.name} bhai, Assalam o Alaikum. Main ${lady} hoon. Bataiye konsi gaari chahiye?`);
  }

  // IMPORTANT: We DO NOT auto-start mic, user must hold-to-talk.
  setStatus(HOLD_HINT);
}

/* =========================
   EVENTS
========================= */
callBtn.addEventListener("click", async ()=>{
  if(!callConnected) await connectCall();
});

// Pointer events = no double firing (touch+mouse)
callBtn.addEventListener("pointerdown", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  try{ callBtn.setPointerCapture(e.pointerId); }catch{}
  startListening(e);
});

callBtn.addEventListener("pointerup", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

callBtn.addEventListener("pointercancel", (e)=>{
  if(!callConnected) return;
  e.preventDefault();
  stopListening();
});

searchBtn.addEventListener("click", async ()=>{
  const t = (query.value||"").trim();
  if(!t) return;
  await runSearch(t);
  const p=getProfile();
  if(p.name){
    await speak(`${p.name} bhai, yeh rahi aap ki search results.`);
  }
});

setStatus("");
hideSupport();
</script>
</body>
</html>
