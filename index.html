<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
header { background:#000; color:#fff; padding:12px; display:flex; gap:12px; align-items:center; }
.logo { background:#E81F25; width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; }
.main { padding:12px; }

.hero { background:#000; border-radius:20px; height:26vh; min-height:170px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:12px; }
.hero h1 { font-size:36px; margin:0; }
.hero h2 { font-size:16px; color:#E81F25; margin-top:6px; }

input,button { width:100%; height:52px; border-radius:14px; font-size:16px; }
input { padding:0 16px; border:1px solid #ccc; margin-bottom:8px; }
button { border:none; background:#000; color:#fff; cursor:pointer; }
.call { background:#E81F25; font-size:18px; margin-top:6px; }
.call.calling { background:#999; color:#000; }

#status { margin-top:8px; font-weight:bold; color:#E81F25; }
#results { margin-top:12px; }

.car { background:#fff; border-radius:14px; padding:10px; margin-bottom:12px; cursor:pointer; }
.car img { width:100%; height:160px; object-fit:cover; border-radius:10px; }
</style>
</head>

<body>

<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Pakistani Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const VOICE_API = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";

const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];

/* =====================================================
   USER MEMORY (PERMANENT)
===================================================== */
function getProfile() {
  return JSON.parse(localStorage.getItem("boloProfile") || "{}");
}
function saveProfile(p) {
  localStorage.setItem("boloProfile", JSON.stringify(p));
}
function getLady() {
  let p = getProfile();
  if (!p.lady) {
    p.lady = LADIES[Math.floor(Math.random() * LADIES.length)];
    saveProfile(p);
  }
  return p.lady;
}

/* =====================================================
   SPEECH RECOGNITION
===================================================== */
let recognition = null;
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-GB";
  recognition.interimResults = false;
}

function startListening(handler) {
  recognition.onresult = e => handler(e.results[0][0].transcript);
  recognition.start();
}

/* =====================================================
   TEXT TO SPEECH
===================================================== */
async function speak(text) {
  status.innerText = text;
  const res = await fetch(VOICE_API, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text })
  });
  const audio = new Audio(URL.createObjectURL(await res.blob()));
  return audio.play();
}

/* =====================================================
   REAL PHONE RING (1â€“3 TIMES)
===================================================== */
function ringPhone(done) {
  const rings = Math.floor(Math.random() * 3) + 1;
  let count = 0;

  function ring() {
    const r = new Audio("ringtone.mp4");
    r.onended = () => {
      count++;
      if (count < rings) setTimeout(ring, 600);
      else done();
    };
    r.play();
  }
  ring();
}

/* =====================================================
   NAME CAPTURE & LOCK
===================================================== */
async function askName(lady) {
  await speak(`Welcome to DrivePK. Mera naam ${lady} hai. May I ask your name?`);
  startListening(async text => {
    const m = text.match(/(my name is|mera naam)\s+(\w+)/i);
    if (!m) {
      await speak("Maaf kijiye, naam samajh nahi aaya. Dobara bataiye.");
      askName(lady);
      return;
    }
    const name = m[2];
    let p = getProfile();
    p.name = name;
    p.lady = lady;
    saveProfile(p);
    await speak(`Shukriya ${name} bhai. Aap kaunsi gaari dhoondhna chahte hain?`);
    startSearchFlow();
  });
}

/* =====================================================
   SEARCH FLOW + MEMORY
===================================================== */
async function startSearchFlow() {
  startListening(async text => {
    query.value = text;
    let p = getProfile();
    p.lastSearch = text;
    saveProfile(p);
    runSearch(text);
  });
}

async function runSearch(text) {
  results.innerHTML = "<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res = await fetch(SEARCH_API, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text })
  });
  const json = await res.json();
  results.innerHTML = "";
  if (!json.data?.length) {
    results.innerHTML = "<p>Koi gaari nahi mili</p>";
    return;
  }
  json.data.forEach(c => {
    results.innerHTML += `
      <div class="car">
        ${c.images?.[0] ? `<img src="${c.images[0]}">` : ""}
        <h3>${c.title}</h3>
        <div>${c.year} â€¢ ${c.location?.city || ""}</div>
        <strong>PKR ${c.price?.toLocaleString() || "Call"}</strong>
      </div>`;
  });
}

/* =====================================================
   CALL BUTTON (MASTER FLOW)
===================================================== */
callBtn.onclick = () => {
  callBtn.classList.add("calling");
  callBtn.innerText = "ðŸ“ž CALLINGâ€¦";
  ringPhone(async () => {
    callBtn.classList.remove("calling");
    callBtn.innerText = "ðŸŽ¤ TALK";

    const p = getProfile();
    const lady = getLady();

    if (!p.name) {
      askName(lady);
    } else {
      await speak(`${p.name} bhai, welcome back. Main ${lady} hoon. Aap ki kya madad kar sakti hoon?`);
      if (p.lastSearch) {
        await speak(`Aakhri dafa aap ne kaha tha: ${p.lastSearch}. Kya aaj bhi wahi dekhni hai?`);
      }
      startSearchFlow();
    }
  });
};

searchBtn.onclick = () => query.value && runSearch(query.value);
</script>

</body>
</html>