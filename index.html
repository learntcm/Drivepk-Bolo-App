<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#e6e6e6; }
header{ background:#000; color:#fff; padding:10px; display:flex; gap:10px; align-items:center; }
.logo{ background:#E81F25; width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:bold; }
.main{ padding:10px; }
.hero{ background:#000; border-radius:18px; height:22vh; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:10px; }
.hero h1{ font-size:30px; margin:0; }
.hero h2{ font-size:14px; color:#E81F25; margin-top:4px; }

input,button{ width:100%; height:46px; border-radius:12px; font-size:15px; }
input{ padding:0 14px; border:1px solid #ccc; margin-bottom:6px; }
button{ border:none; background:#000; color:#fff; cursor:pointer; }

.call{ background:#E81F25; font-size:16px; margin-top:6px; }
.call.calling{ background:#999; color:#000; }

#status{ margin-top:6px; font-weight:bold; color:#E81F25; font-size:14px; }
#results{ margin-top:10px; }
.car{ background:#fff; border-radius:12px; padding:8px; margin-bottom:10px; }
.car img{ width:100%; height:140px; object-fit:cover; border-radius:8px; }

.smallHint{
  margin-top:6px;
  font-size:12px;
  color:#333;
  opacity:0.8;
}
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Pakistani Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>

  <!-- One button that becomes CALL then HOLD-TO-TALK -->
  <button class="call" id="callBtn">ðŸ“ž CALL</button>
  <div class="smallHint" id="hint">Call dabayen. Phir ðŸŽ¤ ko press & hold karke bolen.</div>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];

const HOLD_HINT = "ðŸŽ¤ Press & hold karke bolen. Chhorne par sunna band ho jayega.";
const MIC_FAIL_MAX = 2;                // after 2 failures -> suggest typing
const SILENCE_MS = 5000;               // if user holds but no speech -> reminder
const POST_TTS_GAP_MS = 300;           // small gap after voice ends (stability)

/* =========================
   STATE
========================= */
let callConnected = false;
let currentAudio = null;
let speaking = false;
let listening = false;
let micFailCount = 0;
let silenceTimer = null;

let recognition = null;
let lastTranscript = "";

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){ p.lady = rand(LADIES); saveProfile(p); }
  return p.lady;
}

/* =========================
   SPEECH RECOGNITION SETUP
========================= */
if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-GB";
  recognition.interimResults = false;
  recognition.continuous = false;
}

function clearSilenceTimer(){
  if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; }
}

function hardStopMic(){
  if(!recognition) return;
  try { recognition.onresult=null; recognition.onerror=null; recognition.onend=null; } catch(e){}
  try { recognition.abort(); } catch(e){}
  try { recognition.stop(); } catch(e){}
  listening = false;
  clearSilenceTimer();
}

function setStatus(t){ status.innerText = t; }

/* =========================
   AUDIO (TTS) â€” NO OVERLAP GUARANTEE
   - We never speak if already speaking; we queue by awaiting speak()
========================= */
function stopAudio(){
  if(currentAudio){
    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
    currentAudio = null;
  }
}

async function speak(text){
  // Prevent overlap:
  // Stop mic + stop previous audio before speaking
  hardStopMic();
  stopAudio();
  clearSilenceTimer();

  speaking = true;
  setStatus(text);

  const res = await fetch(VOICE_API, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  const blob = await res.blob();
  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    audio.onended = () => {
      currentAudio = null;
      speaking = false;
      setTimeout(resolve, POST_TTS_GAP_MS);
    };
    audio.onerror = () => {
      currentAudio = null;
      speaking = false;
      resolve();
    };
    audio.play().catch(() => {
      currentAudio = null;
      speaking = false;
      resolve();
    });
  });
}

/* =========================
   RING (1â€“3)
========================= */
async function ringPhone(){
  const rings = Math.floor(Math.random()*3) + 1;
  for(let i=0;i<rings;i++){
    await new Promise(res=>{
      const r = new Audio("ringtone.mp4");
      r.onended = () => setTimeout(res, 450);
      r.play().catch(res);
    });
  }
}

/* =========================
   NAME EXTRACTION (multi-word)
========================= */
function tidyName(raw){
  return raw
    .replace(/[^a-zA-Z\s]/g," ")
    .replace(/\s+/g," ")
    .trim()
    .split(" ")
    .slice(0,3)
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase())
    .join(" ");
}
function extractName(text){
  const t=(text||"").trim();
  let m = t.match(/(my name is|mera naam)\s+(.+)/i);
  if(m) return tidyName(m[2]);
  const cleaned = tidyName(t);
  if(cleaned && cleaned.length >= 2) return cleaned;
  return null;
}

/* =========================
   INTENTS (lady switch + boss)
========================= */
function wantsNewLady(text){
  const t=(text||"").toLowerCase();
  const phrases=[
    "change lady","switch lady","another lady","other lady","new lady",
    "aur madam chahiye","koi khoobsurat lady chahiye","dusri madam","dusri lady",
    "dusri madam se baat karwao","koi aur lady","lady badlo","lady badal do","lady change karo"
  ];
  return phrases.some(p=>t.includes(p));
}
function wantsBoss(text){
  const t=(text||"").toLowerCase();
  const phrases=[
    "boss","manager","supervisor","senior",
    "muje boss se baat karni hai","mujhe boss se baat karni hai",
    "boss se connect karo","manager se baat","supervisor se baat","senior se baat"
  ];
  return phrases.some(p=>t.includes(p));
}

/* =========================
   MESSAGES (Roman Urdu)
========================= */
function welcomeReturning(name){
  const options=[
    `${name} bhai, Assalam o Alaikum. Kya madad karun?`,
    `${name} bhai, salam. Aaj kya dhoondhna hai?`,
    `${name} bhai, welcome back. Bata dein konsi gaari chahiye?`
  ];
  return rand(options);
}

function welcomeFirst(lady){
  const options=[
    `Assalam o Alaikum! DrivePK mein khush aamadid. Main ${lady} hoon.`,
    `Salam! DrivePK se baat ho rahi hai. Main ${lady} hoon.`,
    `Assalam o Alaikum! DrivePK ki taraf se. Main ${lady} hoon.`
  ];
  return rand(options);
}

function askNameLine(){
  const options=[
    "Doctor bhai, aap ka naam kya hai?",
    "Doctor bhai, main aap ka naam jaan sakti hoon?",
    "Doctor bhai, aap apna naam bata dein please."
  ];
  return rand(options);
}

function askRequirementLine(name){
  const options=[
    `${name} bhai, apni requirement bol dein â€” jaise model, year aur city.`,
    `${name} bhai, model aur city bata dein please.`,
    `${name} bhai, konsi gaari chahiye? Model/year/city bol dein.`
  ];
  return rand(options);
}

function typingFallbackLine(){
  return rand([
    "Mujhe aap ki awaaz clear nahi aa rahi. Behtar hai aap type kar dein.",
    "Mic issue lag raha hai. Aap please type karke search kar lein.",
    "Awaaz receive nahi ho rahi. Kindly text box mein likh dein."
  ]);
}

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch(SEARCH_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  let json=null;
  try{ json=await res.json(); }catch(e){}
  results.innerHTML="";

  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }

  json.data.forEach(c=>{
    const img=c.images?.[0]||"";
    const price=c.price?Number(c.price).toLocaleString():"Call";
    results.innerHTML += `
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title||"-"}</h3>
        <div>${c.year||"-"} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });
}

/* =========================
   HOLD-TO-TALK (core fix)
   - start mic on press/hold
   - stop mic on release
========================= */
function startHoldListening(){
  if(!recognition){
    // no speech API available
    micFailCount++;
    speak(typingFallbackLine());
    return;
  }

  if(speaking) return; // do not start mic while audio is playing

  hardStopMic();
  lastTranscript = "";
  listening = true;
  setStatus("ðŸŽ™ Listeningâ€¦ (hold)  " + HOLD_HINT);

  // silence reminder only when mic actually started
  clearSilenceTimer();
  silenceTimer = setTimeout(async ()=>{
    if(listening && !lastTranscript){
      const p=getProfile();
      const name=p.name || "Doctor";
      await speak(`${name} bhai, agar aap bol nahi rahe to model, year aur city bata dein.`);
      // After reminder, user must hold again
      setStatus(HOLD_HINT);
    }
  }, SILENCE_MS);

  recognition.onresult = e => {
    lastTranscript = e.results[0][0].transcript || "";
  };

  recognition.onerror = () => {
    // mic blocked / permission / no input
    micFailCount++;
  };

  recognition.onend = () => {
    // onend fires after stop/abort
    listening = false;
    clearSilenceTimer();
  };

  try { recognition.start(); } catch(e) {
    micFailCount++;
    listening = false;
    clearSilenceTimer();
  }
}

async function stopHoldListeningAndHandle(){
  if(!recognition) return;
  if(!listening) return;

  // stop now; onend will update listening=false
  try { recognition.stop(); } catch(e){}
  clearSilenceTimer();

  // wait a moment for lastTranscript to settle
  setTimeout(async ()=>{
    const spoken = (lastTranscript || "").trim();
    if(!spoken){
      micFailCount++;
      if(micFailCount >= MIC_FAIL_MAX){
        await speak(typingFallbackLine());
        setStatus("Type karke Search karein.");
      } else {
        setStatus("Kuch sunai nahi diya. " + HOLD_HINT);
      }
      return;
    }

    micFailCount = 0;

    // Handle intents
    if(wantsBoss(spoken)){
      const p=getProfile();
      await speak(`${p.name || "Doctor"} sahib, Assalam o Alaikum. Main Senior Advisor hoon. Bataiye, masla kya hai?`);
      setStatus(HOLD_HINT);
      return;
    }
    if(wantsNewLady(spoken)){
      const p=getProfile();
      const current = p.lady || "";
      const choices = LADIES.filter(x=>x!==current);
      p.lady = choices.length ? rand(choices) : rand(LADIES);
      saveProfile(p);
      await speak(`${p.name || "Doctor"} bhai, theek hai. Ab ${p.lady} baat karegi.`);
      await speak(`Assalam o Alaikum ${p.name || "Doctor"} bhai. Main ${p.lady} hoon. Kya madad karun?`);
      setStatus(HOLD_HINT);
      return;
    }

    // Normal search
    query.value = spoken;
    const p=getProfile();
    p.lastSearch = spoken;
    saveProfile(p);
    await runSearch(spoken);

    setStatus("Results aa gaye. Dobara bolna ho to " + HOLD_HINT);
  }, 250);
}

/* =========================
   CALL FLOW
========================= */
async function connectCall(){
  callBtn.classList.add("calling");
  callBtn.innerText="ðŸ“ž CALLINGâ€¦";
  callBtn.disabled=true;

  hardStopMic(); stopAudio(); clearSilenceTimer();

  await ringPhone();

  callConnected = true;
  callBtn.classList.remove("calling");
  callBtn.disabled=false;
  callBtn.innerText="ðŸŽ¤ HOLD TO TALK";
  hint.innerText = HOLD_HINT;

  const p=getProfile();
  const lady=getOrAssignLady();

  if(!p.name){
    await speak(welcomeFirst(lady));
    await speak(askNameLine());
    // Now user must HOLD to speak name
    setStatus("Apna naam bolne ke liye " + HOLD_HINT);
  } else {
    await speak(welcomeReturning(p.name));
    // Do not auto prompt twice; just give ONE requirement line
    await speak(askRequirementLine(p.name));
    setStatus(HOLD_HINT);
  }
}

/* =========================
   HANDLE NAME IF NEEDED
   - If profile has no name, first spoken phrase is treated as name
========================= */
async function maybeSaveNameFromSpoken(spoken){
  const p=getProfile();
  if(p.name) return false;

  const name = extractName(spoken);
  if(!name) return true; // still need name

  p.name = name;
  saveProfile(p);
  await speak(`Shukriya ${name} bhai. Ab apni requirement bol dein â€” jaise model, year aur city.`);
  setStatus(HOLD_HINT);
  return false;
}

/* Modify stop handler to save name first if needed */
const originalStop = stopHoldListeningAndHandle;
stopHoldListeningAndHandle = async function(){
  if(!recognition || !listening) return;

  try { recognition.stop(); } catch(e){}
  clearSilenceTimer();

  setTimeout(async ()=>{
    const spoken = (lastTranscript || "").trim();
    if(!spoken){
      micFailCount++;
      if(micFailCount >= MIC_FAIL_MAX){
        await speak(typingFallbackLine());
        setStatus("Type karke Search karein.");
      } else {
        setStatus("Kuch sunai nahi diya. " + HOLD_HINT);
      }
      return;
    }

    // If name not saved yet, treat first phrase as name
    const stillNeedName = await maybeSaveNameFromSpoken(spoken);
    if(stillNeedName){
      await speak("Naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      setStatus(HOLD_HINT);
      return;
    }

    micFailCount = 0;

    // Handle intents (after name is saved)
    if(wantsBoss(spoken)){
      const p=getProfile();
      await speak(`${p.name || "Doctor"} sahib, Assalam o Alaikum. Main Senior Advisor hoon. Bataiye, masla kya hai?`);
      setStatus(HOLD_HINT);
      return;
    }
    if(wantsNewLady(spoken)){
      const p=getProfile();
      const current = p.lady || "";
      const choices = LADIES.filter(x=>x!==current);
      p.lady = choices.length ? rand(choices) : rand(LADIES);
      saveProfile(p);
      await speak(`${p.name || "Doctor"} bhai, theek hai. Ab ${p.lady} baat karegi.`);
      await speak(`Assalam o Alaikum ${p.name || "Doctor"} bhai. Main ${p.lady} hoon. Kya madad karun?`);
      setStatus(HOLD_HINT);
      return;
    }

    // Normal search
    query.value = spoken;
    const p=getProfile();
    p.lastSearch = spoken;
    saveProfile(p);
    await runSearch(spoken);
    setStatus("Results aa gaye. Dobara bolna ho to " + HOLD_HINT);
  }, 250);
};

/* =========================
   BUTTON WIRING
   - First tap = connect (ring + welcome)
   - After connected: HOLD press/release = mic on/off
========================= */
callBtn.addEventListener("click", async () => {
  if(!callConnected){
    await connectCall();
  }
  // if already connected, click does nothing (hold handles talk)
});

/* Hold-to-talk events (mobile + desktop) */
function bindHoldEvents(btn){
  // Touch (mobile)
  btn.addEventListener("touchstart", (e)=>{
    if(!callConnected) return;
    e.preventDefault();
    startHoldListening();
  }, {passive:false});

  btn.addEventListener("touchend", async (e)=>{
    if(!callConnected) return;
    e.preventDefault();
    await stopHoldListeningAndHandle();
  }, {passive:false});

  // Mouse (desktop)
  btn.addEventListener("mousedown", ()=>{
    if(!callConnected) return;
    startHoldListening();
  });
  btn.addEventListener("mouseup", async ()=>{
    if(!callConnected) return;
    await stopHoldListeningAndHandle();
  });
  btn.addEventListener("mouseleave", async ()=>{
    if(!callConnected) return;
    if(listening) await stopHoldListeningAndHandle();
  });
}
bindHoldEvents(callBtn);

/* Manual Search button */
searchBtn.onclick = async () => {
  const t=query.value.trim();
  if(!t) return;
  const p=getProfile();
  p.lastSearch=t;
  saveProfile(p);
  await runSearch(t);
};

/* On load: show correct label */
(function init(){
  const p=getProfile();
  if(p.name){
    hint.innerText = "Call dabayen. Phir " + HOLD_HINT;
  } else {
    hint.innerText = "Call dabayen. Phir apna naam bolne ke liye " + HOLD_HINT;
  }
})();
</script>
</body>
</html>