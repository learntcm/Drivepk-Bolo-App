<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK AI - Voice</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root { --red:#E81F25; --black:#000; }
body {
  background:#111;
  margin:0;
  font-family:'Segoe UI', sans-serif;
  display:flex;
  justify-content:center;
  height:100vh;
}
.app-container {
  width:100%;
  max-width:420px;
  background:#fff;
  display:flex;
  flex-direction:column;
}
header {
  background:var(--black);
  color:#fff;
  padding:16px;
  text-align:center;
  font-weight:bold;
  border-bottom:4px solid var(--red);
}
.hero {
  height:35vh;
  background:url('https://images.unsplash.com/photo-1533473359331-0135ef1b58bf?q=80&w=800') center/cover;
}
#chat {
  flex-grow:1;
  padding:16px;
  overflow-y:auto;
}
.bubble {
  background:#f2f2f2;
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:10px;
  font-size:15px;
  border-left:4px solid var(--red);
}
.user {
  background:#e81f2515;
  border-left:4px solid var(--black);
}
footer {
  padding:16px;
  display:flex;
  gap:10px;
}
.btn-main, .btn-stop {
  flex:1;
  border:none;
  padding:14px;
  border-radius:12px;
  font-size:16px;
  font-weight:bold;
}
.btn-main { background:var(--red); color:#fff; }
.btn-stop { background:#444; color:#fff; }
</style>
</head>

<body>

<div class="app-container">
  <header>DRIVEPK EXPERT</header>
  <div class="hero"></div>

  <div id="chat">
    <div class="bubble">Click START CALL to begin.</div>
  </div>

  <footer>
    <button class="btn-main" id="callBtn">ðŸ“ž START CALL</button>
    <button class="btn-stop" id="stopBtn">â›” STOP</button>
  </footer>
</div>

<script>
const VOICE_ENDPOINT = "https://meilibeauty.co.uk/voice.php";

// âœ… Browser-safe MP3 ring tone
const ringTone = new Audio(
  "https://cdn.pixabay.com/download/audio/2022/03/15/audio_5c9b4b1f08.mp3"
);

let currentVoice = null;
let recognition = null;
let timers = [];

// Speak using backend TTS
async function speak(text) {
  const res = await fetch(VOICE_ENDPOINT, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ text })
  });
  const blob = await res.blob();
  currentVoice = new Audio(URL.createObjectURL(blob));
  currentVoice.play();
}

// Start microphone listening
function startListening() {
  if (!('webkitSpeechRecognition' in window)) return;

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onresult = (e) => {
    const userText = e.results[0][0].transcript;
    document.getElementById("chat").innerHTML +=
      `<div class="bubble user"><b>You:</b><br>${userText}</div>`;
  };

  recognition.start();
}

// Start call
function startCall() {
  stopAll();

  // Ring 1
  ringTone.currentTime = 0;
  ringTone.play();

  // Ring 2
  timers.push(setTimeout(() => {
    ringTone.currentTime = 0;
    ringTone.play();
  }, 1800));

  // Speak immediately after 2 rings
  timers.push(setTimeout(() => {
    ringTone.pause();

    const greet =
      "Assalam-o-Alaikum, mera naam Reshma hai. Main aap ki kis tarah madad kar sakti hoon?";

    document.getElementById("chat").innerHTML +=
      `<div class="bubble"><b>Reshma:</b><br>${greet}</div>`;
    speak(greet);
  }, 3600));

  // Ask for car model quickly after greeting
  timers.push(setTimeout(() => {
    const ask =
      "Aap kaunsi gaari ka model search karna chahte hain?";

    document.getElementById("chat").innerHTML +=
      `<div class="bubble"><b>Reshma:</b><br>${ask}</div>`;
    speak(ask);

    setTimeout(startListening, 1200);
  }, 7000));
}

// Stop everything immediately
function stopAll() {
  ringTone.pause();
  ringTone.currentTime = 0;

  if (currentVoice) {
    currentVoice.pause();
    currentVoice.currentTime = 0;
  }

  if (recognition) recognition.stop();

  timers.forEach(t => clearTimeout(t));
  timers = [];
}

document.getElementById("callBtn").onclick = startCall;
document.getElementById("stopBtn").onclick = stopAll;
</script>

</body>
</html>
