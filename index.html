<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK Bolo App</title>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f2f2f2}
header{background:#000;color:#fff;padding:12px;display:flex;gap:12px;align-items:center}
.logo{background:#E81F25;width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold}
.main{padding:12px}
.hero{background:#000;border-radius:20px;height:26vh;min-height:170px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:12px}
.hero h1{font-size:36px;margin:0}
.hero h2{font-size:16px;color:#E81F25;margin-top:6px}
input,button{width:100%;height:52px;border-radius:14px;font-size:16px}
input{padding:0 16px;border:1px solid #ccc;margin-bottom:8px}
button{border:none;background:#000;color:#fff;cursor:pointer}
.call{background:#E81F25;font-size:18px;margin-top:6px}
.call.calling{background:#999;color:#000;transform:scale(.97)}
#status{margin-top:8px;font-weight:bold;color:#E81F25}
#results{margin-top:12px}
.car{background:#fff;border-radius:14px;padding:10px;margin-bottom:12px;cursor:pointer}
.car img{width:100%;height:160px;object-fit:cover;border-radius:10px}
</style>
</head>

<body>

<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Roman Urdu Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: MG HS under 40 lakh Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* ===============================
   STATE
=============================== */
const femaleNames=["Reshma","Gul Bahar","Gul Noor","Dil Bahar","Kiran","Shaheen","Chaman","Khushnoor","Mahnoor","Julie","Rosemarie"];
let currentVoiceName="Reshma",ringing=false,callConnected=false;

/* ===============================
   SEARCH NORMALIZER (NEW)
=============================== */
function normalizeQuery(text){
  let t=text.toLowerCase();

  // number words
  const map={
    "ten lakh":"1000000",
    "twenty lakh":"2000000",
    "thirty lakh":"3000000",
    "forty lakh":"4000000",
    "fifty lakh":"5000000"
  };
  for(const k in map){
    t=t.replace(k,map[k]);
  }

  // numeric lakh
  t=t.replace(/(\d+)\s*lakh/g,(m,n)=>String(parseInt(n)*100000));

  // price hints
  t=t.replace(/under|below|less than/g,"max");
  t=t.replace(/above|over|more than/g,"min");

  // transmission
  t=t.replace(/\bauto\b/g,"automatic");

  // cleanup
  t=t.replace(/\s+/g," ").trim();

  return t;
}

/* ===============================
   SPEECH
=============================== */
let recognition=null;
if("webkitSpeechRecognition"in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="en-GB";
  recognition.onresult=e=>{
    const raw=e.results[0][0].transcript;
    const clean=normalizeQuery(raw);
    query.value=raw;
    status.innerText=`${currentVoiceName}: ${raw}`;
    runSearch(clean);
  };
}

/* ===============================
   TTS
=============================== */
async function speakLady(text){
  const res=await fetch("https://meilibeauty.co.uk/voice.php",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });
  const audio=new Audio(URL.createObjectURL(await res.blob()));
  audio.onended=()=>{
    callConnected=true;ringing=false;
    callBtn.classList.remove("calling");
    callBtn.innerText="ðŸŽ¤ TALK";
    callBtn.disabled=false;
    recognition&&recognition.start();
  };
  audio.play();
}

/* ===============================
   RING
=============================== */
function playRingtoneThenSpeak(){
  if(ringing)return;
  ringing=true;
  const ring=new Audio("ringtone.mp4");
  ring.onended=()=>{
    currentVoiceName=femaleNames[Math.floor(Math.random()*femaleNames.length)];
    speakLady(`Assalam o Alaikum, main ${currentVoiceName} hoon. Aap ki kya madad kar sakti hoon?`);
  };
  ring.play();
}

/* ===============================
   SEARCH
=============================== */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch("https://meilibeauty.co.uk/search.php",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });
  const json=await res.json();
  const data=json.data||[];
  if(!data.length){results.innerHTML="<p>Koi gaari nahi mili</p>";return;}
  results.innerHTML="";
  data.forEach(c=>{
    const img=c.images?.[0]||"";
    results.innerHTML+=`
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title}</h3>
        <div>${c.year} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${c.price?.toLocaleString()||"Call"}</strong>
      </div>`;
  });
}

/* ===============================
   BUTTONS
=============================== */
callBtn.onclick=()=>{
  if(!callConnected){
    callBtn.classList.add("calling");
    callBtn.innerText="ðŸ“ž CALLINGâ€¦";
    callBtn.disabled=true;
    playRingtoneThenSpeak();
  }else{
    status.innerText=`${currentVoiceName}: Sun rahi hoonâ€¦`;
    recognition&&recognition.start();
  }
};
searchBtn.onclick=()=>{
  const raw=query.value.trim();
  if(raw)runSearch(normalizeQuery(raw));
};
</script>

</body>
</html>
