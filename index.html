<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
header { background:#000; color:#fff; padding:12px; display:flex; gap:12px; align-items:center; }
.logo { background:#E81F25; width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; }
.main { padding:12px; }
.hero { background:#000; border-radius:20px; height:26vh; min-height:170px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; margin-bottom:12px; }
.hero h1 { font-size:36px; margin:0; }
.hero h2 { font-size:16px; color:#E81F25; margin-top:6px; }
input,button { width:100%; height:52px; border-radius:14px; font-size:16px; }
input { padding:0 16px; border:1px solid #ccc; margin-bottom:8px; }
button { border:none; background:#000; color:#fff; cursor:pointer; }
.call { background:#E81F25; font-size:18px; margin-top:6px; }
.call.calling { background:#999; color:#000; }
#status { margin-top:8px; font-weight:bold; color:#E81F25; }
#results { margin-top:12px; }
.car { background:#fff; border-radius:14px; padding:10px; margin-bottom:12px; }
.car img { width:100%; height:160px; object-fit:cover; border-radius:10px; }
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Roman Urdu Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const TONES = ["friendly","direct","formal"]; // locked per user

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }

function rand(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

function getOrAssignLady(){
  const p = getProfile();
  if (!p.lady) { p.lady = rand(LADIES); saveProfile(p); }
  return p.lady;
}

function getOrAssignTone(){
  const p = getProfile();
  if (!p.tone) { p.tone = rand(TONES); saveProfile(p); }
  return p.tone;
}

function bumpCallCount(){
  const p = getProfile();
  p.calls = (p.calls || 0) + 1;
  saveProfile(p);
  return p.calls;
}

/* =========================
   SPEECH RECOGNITION
========================= */
let recognition=null;
if("webkitSpeechRecognition"in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="en-GB";
  recognition.interimResults=false;
}

function listenOnce(callback){
  if(!recognition){
    status.innerText="Aap ka browser voice support nahi karta.";
    return;
  }
  try { recognition.stop(); } catch(e){}
  recognition.onresult=e=>callback(e.results[0][0].transcript);
  recognition.onerror=()=>{};
  recognition.start();
}

/* =========================
   SAFE SPEAK (wait audio end)
========================= */
async function speak(text){
  status.innerText=text;
  const res=await fetch(VOICE_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });
  const audio=new Audio(URL.createObjectURL(await res.blob()));
  return new Promise(resolve=>{
    audio.onended=resolve;
    audio.play().catch(resolve);
  });
}

/* =========================
   RING (1-3 realistic)
========================= */
async function ringPhone(){
  const rings = Math.floor(Math.random()*3) + 1; // 1..3
  for(let i=0;i<rings;i++){
    await new Promise(res=>{
      const r=new Audio("ringtone.mp4");
      r.onended=()=>setTimeout(res,500);
      r.play().catch(res);
    });
  }
}

/* =========================
   WELCOME VARIATIONS (Roman Urdu)
   - Different tones
   - Different on first vs later calls
========================= */
function buildWelcomeFirst(lady, tone){
  const base = {
    friendly: [
      `Assalam o Alaikum! DrivePK mein khush aamadid. Main ${lady} hoon.`,
      `Salam! DrivePK se baat ho rahi hai. Main ${lady} hoon.`,
      `Assalam o Alaikum! Welcome to DrivePK. Main ${lady} hoon.`
    ],
    direct: [
      `Assalam o Alaikum. DrivePK. Main ${lady} hoon.`,
      `Salam. DrivePK se ${lady} baat kar rahi hoon.`,
      `Assalam o Alaikum. Main ${lady} hoon, DrivePK se.`
    ],
    formal: [
      `Assalam o Alaikum. DrivePK mein khush aamadid. Main ${lady} baat kar rahi hoon.`,
      `Assalam o Alaikum. DrivePK se ${lady} hazir hai.`,
      `Assalam o Alaikum. Main ${lady} hoon. Aap ki rehnumai ke liye hazir hoon.`
    ]
  };
  return rand(base[tone] || base.friendly);
}

function buildAskName(tone){
  const asks = {
    friendly: [
      "Aap ka naam kya hai?",
      "Main aap ka naam jaan sakti hoon?",
      "Aap ka naam bata dein please."
    ],
    direct: [
      "Aap ka naam?",
      "Naam bata dein.",
      "Aap ka naam kya hai?"
    ],
    formal: [
      "Meherbani farma kar apna naam batayein.",
      "Aap apna naam share kar dein please.",
      "Aap ka naam maloom ho sakta hai?"
    ]
  };
  return rand(asks[tone] || asks.friendly);
}

function buildWelcomeReturning(name, lady, tone){
  const base = {
    friendly: [
      `${name} bhai, Assalam o Alaikum! Main ${lady} hoon. Aaj kya dhoondhna hai?`,
      `${name} bhai, welcome back! Main ${lady} hoon. Bata dein kis qisam ki gaari chahiye?`,
      `${name} bhai, salam! Main ${lady}. Aap ki kya madad karun?`
    ],
    direct: [
      `${name} bhai, salam. Main ${lady}. Kya chahiye?`,
      `${name} bhai, Assalam o Alaikum. Main ${lady}. Gaari ka model bata dein.`,
      `${name} bhai, salam. Aaj ka search bata dein.`
    ],
    formal: [
      `${name} bhai, Assalam o Alaikum. Main ${lady} hoon. Aap ki khidmat mein hazir hoon.`,
      `${name} bhai, salam. Main ${lady}. Meherbani farma kar apni requirement batayein.`,
      `${name} bhai, Assalam o Alaikum. Main ${lady} hoon. Aap kya dekhna chahein ge?`
    ]
  };
  return rand(base[tone] || base.friendly);
}

function buildFollowUpLastSearch(last, tone){
  if(!last) return null;
  const lines = {
    friendly: [
      `Pichli dafa aap ne kaha tha: ${last}. Aaj bhi wahi dekhni hai?`,
      `Last time aap ne bola tha: ${last}. Aaj bhi same?`,
      `Aap ki last search thi: ${last}. Usi per chalen?`
    ],
    direct: [
      `Last search: ${last}. Same karni hai?`,
      `Pichli search ${last}. Haan ya nahin?`,
      `${last} â€” isi per chalen?`
    ],
    formal: [
      `Aap ki pichli search: ${last}. Kya aaj bhi isi per proceed karein?`,
      `Aap ne pehle ${last} search kiya tha. Kya wohi dekhna pasand karein ge?`,
      `Pichli martaba: ${last}. Kya aaj bhi wohi chahiye?`
    ]
  };
  return rand(lines[tone] || lines.friendly);
}

/* =========================
   NAME CAPTURE
========================= */
function extractName(text){
  const t = (text || "").toLowerCase().trim();

  // supports: "my name is Abdullah" / "mera naam Abdullah" / "Abdullah"
  let m = t.match(/(my name is|mera naam)\s+([a-zA-Z]{2,20})/i);
  if (m) return cap(m[2]);

  // if user just says a single name word
  if (/^[a-zA-Z]{2,20}$/.test(t)) return cap(t);

  return null;
}
function cap(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch(SEARCH_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  let json=null;
  try { json = await res.json(); } catch(e){}

  results.innerHTML="";
  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }

  json.data.forEach(c=>{
    const img = c.images?.[0] || "";
    const price = c.price ? Number(c.price).toLocaleString() : "Call";
    results.innerHTML += `
      <div class="car">
        ${img ? `<img src="${img}">` : ""}
        <h3>${c.title || "-"}</h3>
        <div>${c.year || "-"} â€¢ ${c.location?.city || "-"}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });
}

function startSearchListening(){
  listenOnce(async text=>{
    query.value = text;
    const p=getProfile();
    p.lastSearch = text;
    saveProfile(p);
    await runSearch(text);
    // after showing results, allow talking again
    status.innerText = "Agar aap dobara bolna chahein to ðŸŽ¤ TALK dabayein.";
  });
}

/* =========================
   CALL FLOW
========================= */
async function firstTimeFlow(lady, tone){
  const welcome = buildWelcomeFirst(lady, tone);
  await speak(welcome);
  await speak(buildAskName(tone));

  listenOnce(async userText=>{
    const name = extractName(userText);
    if(!name){
      await speak("Maaf kijiye, naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      return firstTimeFlow(lady, tone);
    }
    const p=getProfile();
    p.name=name;
    p.lady=lady;
    saveProfile(p);

    await speak(`Shukriya ${name} bhai. Ab aap kis gaari ki talash kar rahe hain?`);
    startSearchListening();
  });
}

async function returningFlow(name, lady, tone){
  await speak(buildWelcomeReturning(name, lady, tone));

  const p=getProfile();
  const follow = buildFollowUpLastSearch(p.lastSearch, tone);
  if (follow) {
    await speak(follow);
    // user says: "haan" / "nahin" / new query
    listenOnce(async txt=>{
      const t = (txt||"").toLowerCase();
      if (t.includes("haan") || t.includes("yes") || t.includes("han")) {
        await speak("Theek hai, main wahi dhoondti hoon.");
        runSearch(p.lastSearch);
        return;
      }
      if (t.includes("nahin") || t.includes("no") || t.includes("nahi")) {
        await speak("Theek hai, phir aap apni new requirement bol dein.");
        startSearchListening();
        return;
      }
      // treat as new query
      query.value = txt;
      p.lastSearch = txt;
      saveProfile(p);
      await runSearch(txt);
    });
  } else {
    await speak("Aap apni requirement bol dein, jaise model, year aur city.");
    startSearchListening();
  }
}

/* =========================
   UI BUTTONS
========================= */
callBtn.onclick = async () => {
  callBtn.classList.add("calling");
  callBtn.innerText = "ðŸ“ž CALLINGâ€¦";
  callBtn.disabled = true;

  // Bump call count for variation (stored)
  bumpCallCount();

  // realistic ring
  await ringPhone();

  callBtn.classList.remove("calling");
  callBtn.innerText = "ðŸŽ¤ TALK";
  callBtn.disabled = false;

  const p = getProfile();
  const lady = getOrAssignLady();
  const tone = getOrAssignTone();

  if (!p.name) {
    await firstTimeFlow(lady, tone);
  } else {
    await returningFlow(p.name, lady, tone);
  }
};

searchBtn.onclick = () => {
  const t = query.value.trim();
  if(!t) return;
  const p=getProfile();
  p.lastSearch=t;
  saveProfile(p);
  runSearch(t);
};
</script>
</body>
</html>