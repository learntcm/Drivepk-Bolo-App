<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DrivePK BOLO</title>

<style>
  body{margin:0;font-family:Arial,sans-serif;background:#e6e6e6;}
  header{background:#000;color:#fff;padding:10px;display:flex;gap:10px;align-items:center;}
  .logo{background:#E81F25;width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;}
  .main{padding:10px;max-width:520px;margin:0 auto;}
  .hero{background:#000;border-radius:18px;height:22vh;min-height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;margin-bottom:10px;}
  .hero h1{font-size:30px;margin:0;}
  .hero h2{font-size:14px;color:#E81F25;margin-top:4px;}

  input,button{width:100%;height:46px;border-radius:12px;font-size:15px;box-sizing:border-box;}
  input{padding:0 14px;border:1px solid #ccc;margin-bottom:6px;}
  button{border:none;background:#000;color:#fff;cursor:pointer;}

  .row{display:flex;gap:8px;}
  .row button{flex:1;}

  .call{background:#E81F25;font-size:16px;margin-top:6px;user-select:none;transition:filter .08s ease,transform .08s ease;}
  .call.calling{background:#999;color:#000;}
  .call.talking{filter:brightness(0.78);transform:scale(0.985);}

  #hint{margin-top:6px;font-size:12px;color:#333;opacity:.85;}
  #status{margin-top:6px;font-weight:bold;color:#E81F25;font-size:14px;}
  #results{margin-top:10px;}

  .card{background:#fff;border-radius:12px;padding:10px;margin-bottom:10px;}
  .car{background:#fff;border-radius:12px;padding:8px;margin-bottom:10px;cursor:pointer;}
  .car img{width:100%;height:140px;object-fit:cover;border-radius:8px;}

  .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;}
  .muted{opacity:.75;font-size:12px;}
  .btnRed{background:#E81F25 !important;}

  /* Support box */
  #supportBox{display:none;margin-top:10px;background:#fff;border-radius:12px;padding:10px;}

  /* Modal */
  .modalBack{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center; z-index:9999;
    padding:12px;
  }
  .modal{
    width:100%; max-width:420px; background:#fff; border-radius:14px; padding:12px;
  }
  .modal h3{margin:0 0 8px 0;}
  .modal .row2{display:flex; gap:8px; margin-top:8px;}
  .modal .row2 button{flex:1; height:44px;}
  .xbtn{float:right;background:#eee;color:#000;width:40px;height:36px;border-radius:10px;}
  .small{font-size:12px; opacity:.8; margin-top:6px;}
  .ok{color:#0a7a2f; font-weight:bold;}
  .bad{color:#b00020; font-weight:bold;}

  /* Detail Page */
  #detailPage{
    position:fixed; inset:0; background:#fff; z-index:999; display:none; overflow-y:auto;
  }
  .detailHeader{
    background:#000;color:#fff;padding:10px;display:flex;align-items:center;gap:10px;position:sticky;top:0;
  }
  .detailHeader button{background:#E81F25;border-radius:10px;padding:8px 10px;color:#fff;}
  .galleryWrap{background:#000;position:relative;}
  .gallery{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;}
  .gallery img{width:100%;height:240px;object-fit:cover;scroll-snap-align:start;flex-shrink:0;border-right:6px solid #000;}
  .swipe{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;}
  .detailBody{padding:12px;}
  .price{font-size:22px;font-weight:bold;margin:6px 0 12px 0;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
  .box{background:#111;color:#fff;border-radius:12px;padding:10px 6px;text-align:center;font-size:13px;}
  .box strong{display:block;font-size:15px;margin-top:4px;}
  .contactBox{background:#000;color:#fff;border-radius:14px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .contactBtn{background:#E81F25;color:#fff;border-radius:12px;padding:10px 12px;font-weight:bold;min-width:140px;text-align:center;}
  .lock{opacity:.7;font-size:13px;}
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br />
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Voice Search</h2>
  </div>

  <input id="query" placeholder="Jaise: MG Lahore 2022" />
  <div class="row">
    <button id="searchBtn">Search</button>
    <button id="authBtn" class="btnRed">Login</button>
  </div>

  <button class="call" id="callBtn">CALL</button>
  <div id="hint">Call dabayen. Phir mic ko press & hold karke bolen.</div>

  <div id="status"></div>

  <div id="supportBox" class="card">
    <strong>Complaints / Support:</strong>
    <div style="margin-top:6px;font-size:18px;color:#E81F25;font-weight:bold;">051 8319037</div>
    <div class="small">Please call this number for complaints.</div>
  </div>

  <div id="results"></div>
</div>

<div id="detailPage">
  <div class="detailHeader">
    <button id="backBtn">‚Üê Back</button>
    <strong id="detailTitle"></strong>
  </div>

  <div class="galleryWrap">
    <div class="gallery" id="gallery"></div>
    <div class="swipe">Swipe ‚á† ‚á¢</div>
  </div>

  <div class="detailBody">
    <div class="price" id="detailPrice"></div>

    <div class="grid" id="specGrid"></div>

    <div class="contactBox">
      <div>
        <div class="lock" id="contactHint">üîí Login to view phone number</div>
        <div class="muted" id="sellerName"></div>
      </div>
      <div class="contactBtn" id="contactBtn">Contact Seller</div>
    </div>

    <div id="phoneBox" class="card" style="display:none;margin-top:10px;">
      <div class="pill">Contact</div>
      <div style="margin-top:6px;font-size:20px;font-weight:bold;color:#E81F25;" id="realPhone"></div>
      <div class="small" id="phoneOwner"></div>
    </div>
  </div>
</div>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <button class="xbtn" id="closeModal">‚úï</button>
    <h3 id="modalTitle">Login</h3>

    <div id="modalMsg" class="small"></div>

    <div id="loginForm">
      <input id="loginEmail" placeholder="Email" />
      <input id="loginPass" placeholder="Password" type="password" />
      <div class="row2">
        <button id="doLogin" class="btnRed">Login</button>
        <button id="goRegister">Register</button>
      </div>
      <div class="small">If token expires, we auto-refresh.</div>
    </div>

    <div id="registerForm" style="display:none;">
      <input id="regName" placeholder="Full Name" />
      <input id="regEmail" placeholder="Email" />
      <input id="regPhone" placeholder="Phone (3001234567)" />
      <input id="regPass" placeholder="Password (Password123)" type="password" />
      <input id="regPass2" placeholder="Confirm Password" type="password" />
      <div class="row2">
        <button id="doRegister" class="btnRed">Create</button>
        <button id="goLogin">Back</button>
      </div>
    </div>

    <div id="loggedInBox" style="display:none;">
      <div class="card">
        <div class="pill">Logged In</div>
        <div style="margin-top:6px;font-weight:bold;" id="whoami"></div>
        <div class="small" id="whoEmail"></div>
      </div>
      <button id="logoutBtn" style="background:#000;margin-top:8px;">Logout</button>
    </div>
  </div>
</div>

<script>
/* =========================
    CONFIG (Direct to DrivePK Production)
========================= */
const DRIVEPK_API = "https://api.drivepk.com";
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const COMPANY_NUMBER = "051 8319037";
const OFFICE_ADDRESS = "195, Peshawar Road, Chur Chowk Beside PSO Pump, Rawalpindi.";

const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const VOICE_BY_LADY = {
  "Kiran":    { voice:"marin",   speed:0.95 },
  "Reshma":    { voice:"cedar",   speed:0.95 },
  "Mahnoor":  { voice:"shimmer", speed:0.98 },
  "Gul Noor": { voice:"coral",   speed:0.95 },
  "Dil Bahar":{ voice:"nova",    speed:0.98 },
  "Shaheen":  { voice:"sage",    speed:0.95 }
};

const BOSS_UMAR = { voice:"coral", speed:0.95 };

const RESULT_LINES = ["Acha jee, results aa gaye hain.", "Theek hai, matching gaariyan mil gayi hain."];
const NO_RESULT_LINES = ["Maazrat, koi matching gaari nahi mili."];
const UNKNOWN_LINES = ["Abhi main sirf gaari search mein help karti hoon."];

/* =========================
    STATE & STORAGE
========================= */
let callConnected = false;
let recognition = null;
let isRecognizing = false;
let transcript = "";
let silenceTimer = null;
let micReady = false;
let currentAudio = null;
let speakSeq = 0;
let holding = false;
let holdStartTs = 0;
let lastResults = [];
let currentCar = null;

function $(id){ return document.getElementById(id); }
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }

function getTokens(){
  return {
    access: localStorage.getItem("dp_access") || "",
    refresh: localStorage.getItem("dp_refresh") || "",
    expiresAt: parseInt(localStorage.getItem("dp_expiresAt") || "0", 10) || 0,
    user: JSON.parse(localStorage.getItem("dp_user") || "null")
  };
}

function setTokens(data){
  if(!data) return;
  if(data.access_token) localStorage.setItem("dp_access", data.access_token);
  if(data.refresh_token) localStorage.setItem("dp_refresh", data.refresh_token);
  if(data.expires_in) localStorage.setItem("dp_expiresAt", String(Date.now() + (data.expires_in*1000)));
  if(data.user) localStorage.setItem("dp_user", JSON.stringify(data.user));
}

/* =========================
    VOICE ENGINE
========================= */
async function speak(text, voicePack){
  const mySeq = ++speakSeq;
  const vp = voicePack || VOICE_BY_LADY[getProfile().lady || "Kiran"];
  try{
    const res = await fetch(VOICE_API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text, voice: vp.voice, speed: vp.speed })
    });
    if(!res.ok) return;
    const blob = await res.blob();
    if(mySeq !== speakSeq) return;
    const audio = new Audio(URL.createObjectURL(blob));
    currentAudio = audio;
    return new Promise(r => { audio.onended = r; audio.play().catch(r); });
  } catch(e) {}
}

/* =========================
    REAL SEARCH LOGIC (No extra file)
========================= */
async function runSearch(text){
  $("results").innerHTML = "<p>Dhoondi ja rahi hain...</p>";
  try {
    // Calling the REAL DrivePK API search endpoint
    const response = await fetch(`${DRIVEPK_API}/cars?query=${encodeURIComponent(text)}`);
    const json = await response.json();
    
    // API usually returns 'carAds' or 'data'
    lastResults = json.carAds || json.data || json.cars || [];
    $("results").innerHTML = "";

    if(!lastResults.length){
      $("results").innerHTML = "<p>No cars found.</p>";
      return 0;
    }

    lastResults.forEach((c, i) => {
      const img = (c.images && c.images[0]) ? c.images[0] : "";
      const price = c.price ? Number(c.price).toLocaleString() : "Call";
      $("results").innerHTML += `
        <div class="car" onclick="openDetail(${i})">
          ${img ? `<img src="${img}">` : ""}
          <h3 style="margin:8px 0 4px 0;">${c.title}</h3>
          <div class="muted">${c.year} ‚Ä¢ ${c.location.city}</div>
          <strong>PKR ${price}</strong>
        </div>`;
    });
    return lastResults.length;
  } catch(e) {
    $("results").innerHTML = "<p>Connection error.</p>";
    return 0;
  }
}

/* =========================
    DETAIL PAGE & PHONE
========================= */
window.openDetail = function(i){
  currentCar = lastResults[i];
  $("detailPage").style.display = "block";
  $("detailTitle").innerText = currentCar.title;
  $("detailPrice").innerText = "PKR " + (currentCar.price ? currentCar.price.toLocaleString() : "Call");
  $("gallery").innerHTML = (currentCar.images || []).map(u => `<img src="${u}">`).join('');
  $("specGrid").innerHTML = `
    <div class="box">Year<strong>${currentCar.year}</strong></div>
    <div class="box">City<strong>${currentCar.location.city}</strong></div>
    <div class="box">Mileage<strong>${currentCar.mileage}km</strong></div>`;
  $("phoneBox").style.display = "none";
};

$("contactBtn").onclick = async () => {
  const t = getTokens();
  if(!t.access){ openAuthModal(); return; }
  
  const res = await fetch(`${DRIVEPK_API}/cars/${currentCar._id}/phone`, {
    headers: { "Authorization": `Bearer ${t.access}` }
  });
  const json = await res.json();
  if(res.ok){
    $("phoneBox").style.display = "block";
    $("realPhone").innerText = json.phone;
  } else {
    alert(json.message || "Login to view number");
  }
};

/* =========================
    AUTH LOGIC
========================= */
$("doLogin").onclick = async () => {
  const res = await fetch(`${DRIVEPK_API}/auth/mobile/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: $("loginEmail").value, password: $("loginPass").value })
  });
  const json = await res.json();
  if(res.ok && json.success){
    setTokens(json.data);
    closeAuthModal();
    speak("Login successful!");
  } else {
    alert("Login failed");
  }
};

// UI Events
$("searchBtn").onclick = () => runSearch($("query").value);
$("backBtn").onclick = () => { $("detailPage").style.display = "none"; };
$("authBtn").onclick = openAuthModal;
$("closeModal").onclick = closeAuthModal;

function openAuthModal(){ $("modalBack").style.display = "flex"; }
function closeAuthModal(){ $("modalBack").style.display = "none"; }

/* =========================
    VOICE HANDLER
========================= */
async function handleSpoken(text){
  $("query").value = text;
  const count = await runSearch(text);
  if(count > 0) await speak("Results mil gaye hain.");
  else await speak("Koi gaari nahi mili.");
}

// ... Mic logic (Same as your original code) ...
</script>
</body>
</html>
