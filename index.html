<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DrivePK BOLO</title>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#e6e6e6; }

/* HEADER */
header{
  background:#000; color:#fff; padding:10px;
  display:flex; gap:10px; align-items:center;
}
.logo{
  background:#E81F25; width:38px; height:38px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:bold;
}
.main{ padding:10px; }

/* HERO */
.hero{
  background:#000; border-radius:18px;
  height:22vh; min-height:140px;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  color:#fff; margin-bottom:10px;
}
.hero h1{ font-size:30px; margin:0; }
.hero h2{ font-size:14px; color:#E81F25; margin-top:4px; }

input,button{ width:100%; height:46px; border-radius:12px; font-size:15px; }
input{ padding:0 14px; border:1px solid #ccc; margin-bottom:6px; }
button{ border:none; background:#000; color:#fff; cursor:pointer; }

.call{ background:#E81F25; font-size:16px; margin-top:6px; }
.call.calling{ background:#999; color:#000; }

#status{ margin-top:6px; font-weight:bold; color:#E81F25; font-size:14px; }
#results{ margin-top:10px; }

.car{ background:#fff; border-radius:12px; padding:8px; margin-bottom:10px; }
.car img{ width:100%; height:140px; object-fit:cover; border-radius:8px; }
</style>
</head>

<body>
<header>
  <div class="logo">D</div>
  <div>
    <strong>DrivePK</strong><br>
    <small>Bolo aur gaari dhoondo</small>
  </div>
</header>

<div class="main">
  <div class="hero">
    <h1>DrivePK</h1>
    <h2>Pakistani Voice Assistant</h2>
  </div>

  <input id="query" placeholder="Jaise: Toyota Corolla 2019 Lahore">
  <button id="searchBtn">Search</button>
  <button class="call" id="callBtn">ðŸ“ž CALL</button>

  <div id="status"></div>
  <div id="results"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const VOICE_API  = "https://meilibeauty.co.uk/voice.php";
const SEARCH_API = "https://meilibeauty.co.uk/search.php";
const LADIES = ["Kiran","Reshma","Mahnoor","Gul Noor","Dil Bahar","Shaheen"];
const TONES  = ["friendly","direct","formal"];

/* mic timing */
const MIC_SAFE_DELAY_MS = 1500;          // stronger delay to avoid cutting audio on Android
const SILENCE_REMINDER_MS = 5000;        // if user stays silent, prompt again after 5s

/* =========================
   STATE
========================= */
let callConnected = false;               // IMPORTANT: prevents re-ringing on TALK
let silenceTimer = null;
let currentAudio = null;

/* =========================
   STORAGE
========================= */
function getProfile(){ return JSON.parse(localStorage.getItem("boloProfile") || "{}"); }
function saveProfile(p){ localStorage.setItem("boloProfile", JSON.stringify(p)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function getOrAssignLady(){
  const p=getProfile();
  if(!p.lady){ p.lady = rand(LADIES); saveProfile(p); }
  return p.lady;
}
function getOrAssignTone(){
  const p=getProfile();
  if(!p.tone){ p.tone = rand(TONES); saveProfile(p); }
  return p.tone;
}

/* =========================
   SPEECH RECOGNITION
========================= */
let recognition=null;
if("webkitSpeechRecognition" in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="en-GB";
  recognition.interimResults=false;
  recognition.continuous=false;
}

function hardStopMic(){
  if(!recognition) return;
  try { recognition.onresult=null; recognition.onerror=null; } catch(e){}
  try { recognition.abort(); } catch(e){}
  try { recognition.stop(); } catch(e){}
}

function clearSilenceTimer(){
  if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer=null; }
}

function listenOnce(callback){
  if(!recognition){
    status.innerText="Aap ka browser voice support nahi karta.";
    return;
  }
  hardStopMic();
  clearSilenceTimer();

  // Start a silence reminder: only triggers if user doesn't speak
  silenceTimer = setTimeout(async ()=>{
    // If user still hasn't spoken, give a reminder then listen again
    await speak("Doctor bhai, agar aap bol nahi rahe to model, year aur city bata dein.");
    listenOnce(callback);
  }, SILENCE_REMINDER_MS);

  setTimeout(()=>{
    recognition.onresult = e => {
      clearSilenceTimer();
      callback(e.results[0][0].transcript);
    };
    recognition.onerror = () => {
      // keep calm; silence reminder will handle retry
    };
    try { recognition.start(); } catch(e){}
  }, MIC_SAFE_DELAY_MS);
}

/* =========================
   AUDIO (TTS)
========================= */
function stopAudio(){
  if(currentAudio){
    try { currentAudio.pause(); currentAudio.currentTime=0; } catch(e){}
    currentAudio=null;
  }
}

async function speak(text){
  hardStopMic();     // never overlap mic + audio
  stopAudio();
  clearSilenceTimer();

  status.innerText = text;

  const res = await fetch(VOICE_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  const blob = await res.blob();
  const audio = new Audio(URL.createObjectURL(blob));
  currentAudio = audio;

  return new Promise(resolve=>{
    audio.onended = () => { currentAudio=null; setTimeout(resolve, 250); };
    audio.onerror = () => { currentAudio=null; resolve(); };
    audio.play().catch(()=>{ currentAudio=null; resolve(); });
  });
}

/* =========================
   RING (1â€“3 times)
========================= */
async function ringPhone(){
  const rings = Math.floor(Math.random()*3) + 1;
  for(let i=0;i<rings;i++){
    await new Promise(res=>{
      const r = new Audio("ringtone.mp4");
      r.onended = () => setTimeout(res, 450);
      r.play().catch(res);
    });
  }
}

/* =========================
   MESSAGES (Roman Urdu)
   - Returning user: NO lady name repeated
========================= */
function firstWelcome(lady){
  // first time: you can still mention name because you're introducing
  const options = [
    `Assalam o Alaikum! DrivePK mein khush aamadid. Main ${lady} hoon.`,
    `Salam! DrivePK se baat ho rahi hai. Main ${lady} hoon.`,
    `Assalam o Alaikum! DrivePK ki taraf se. Main ${lady} hoon.`
  ];
  return rand(options);
}

function askNameLine(){
  const options = [
    "Doctor bhai, aap ka naam kya hai?",
    "Doctor bhai, main aap ka naam jaan sakti hoon?",
    "Doctor bhai, aap apna naam bata dein please."
  ];
  return rand(options);
}

function returningWelcome(name){
  // returning: DO NOT say lady name
  const options = [
    `${name} bhai, Assalam o Alaikum. Kya madad karun?`,
    `${name} bhai, salam. Aaj kya dhoondhna hai?`,
    `${name} bhai, welcome back. Bata dein aap ko konsi gaari chahiye?`
  ];
  return rand(options);
}

function promptForQuery(){
  // This should NOT be immediate after welcome unless user presses TALK.
  return rand([
    "Aap apni requirement bol dein, jaise model, year aur city.",
    "Model, year aur city bata dein please.",
    "Konsi gaari chahiye? Model aur city bata dein."
  ]);
}

/* =========================
   NAME EXTRACTION (multi-word)
========================= */
function tidyName(raw){
  return raw
    .replace(/[^a-zA-Z\s]/g," ")
    .replace(/\s+/g," ")
    .trim()
    .split(" ")
    .slice(0,3)
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase())
    .join(" ");
}
function extractName(text){
  const t=(text||"").trim();
  let m = t.match(/(my name is|mera naam)\s+(.+)/i);
  if(m) return tidyName(m[2]);
  const cleaned = tidyName(t);
  if(cleaned && cleaned.length >= 2) return cleaned;
  return null;
}

/* =========================
   SEARCH
========================= */
async function runSearch(text){
  results.innerHTML="<p>Gaariyan dhoondi ja rahi hainâ€¦</p>";
  const res=await fetch(SEARCH_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text})
  });

  let json=null;
  try{ json=await res.json(); }catch(e){}

  results.innerHTML="";
  if(!json || !json.data || !json.data.length){
    results.innerHTML="<p>Koi gaari nahi mili</p>";
    return;
  }

  json.data.forEach(c=>{
    const img=c.images?.[0]||"";
    const price=c.price?Number(c.price).toLocaleString():"Call";
    results.innerHTML += `
      <div class="car">
        ${img?`<img src="${img}">`:""}
        <h3>${c.title||"-"}</h3>
        <div>${c.year||"-"} â€¢ ${c.location?.city||"-"}</div>
        <strong>PKR ${price}</strong>
      </div>
    `;
  });
}

/* =========================
   TALK MODE (no ringing)
   - When connected: TALK just listens
   - Silence reminder triggers after 5s if user doesn't speak
========================= */
async function startTalkForSearch(){
  await speak(promptForQuery());
  listenOnce(async spoken=>{
    query.value = spoken;
    const p=getProfile();
    p.lastSearch = spoken;
    saveProfile(p);
    await runSearch(spoken);
    status.innerText="Agar dobara bolna ho to ðŸŽ¤ TALK dabayein.";
  });
}

/* =========================
   FLOWS
========================= */
async function firstTimeFlow(){
  const lady = getOrAssignLady();
  await speak(firstWelcome(lady));
  await speak(askNameLine());

  listenOnce(async userText=>{
    const name = extractName(userText);
    if(!name){
      await speak("Maaf kijiye, naam clear nahi aaya. Sirf apna naam dobara bol dein.");
      return firstTimeFlow();
    }
    const p=getProfile();
    p.name=name;
    p.lady=lady;
    saveProfile(p);

    // NOTE: Do NOT instantly repeat second prompt; go into talk mode now
    await speak(`Shukriya ${name} bhai. Ab aap kis gaari ki talash kar rahe hain?`);
    await startTalkForSearch();
  });
}

async function returningFlow(){
  const p=getProfile();
  await speak(returningWelcome(p.name || "Doctor"));
  // IMPORTANT: we do NOT auto-start mic immediately here.
  // The user will press TALK to speak OR we can start talk automatically.
  // Since you want smoother UX, we start listening after a short pause with a 5s reminder.
  await startTalkForSearch();
}

/* =========================
   BUTTON BEHAVIOR
   - First press: CALL = ring + connect + welcome
   - After connected: TALK = just listen (NO RINGING)
========================= */
callBtn.onclick = async () => {
  // If already connected, behave like TALK (no ringing)
  if(callConnected){
    callBtn.innerText="ðŸŽ¤ LISTENINGâ€¦";
    await startTalkForSearch();
    callBtn.innerText="ðŸŽ¤ TALK";
    return;
  }

  callBtn.classList.add("calling");
  callBtn.innerText="ðŸ“ž CALLINGâ€¦";
  callBtn.disabled=true;

  hardStopMic(); stopAudio(); clearSilenceTimer();

  await ringPhone();

  callConnected = true;                // âœ… now connected, no more ringing on next presses
  callBtn.classList.remove("calling");
  callBtn.disabled=false;
  callBtn.innerText="ðŸŽ¤ TALK";          // show TALK after connect

  const p=getProfile();
  if(!p.name) await firstTimeFlow();
  else await returningFlow();
};

searchBtn.onclick = async () => {
  const t=query.value.trim();
  if(!t) return;
  const p=getProfile();
  p.lastSearch=t;
  saveProfile(p);
  await runSearch(t);
};
</script>
</body>
</html>